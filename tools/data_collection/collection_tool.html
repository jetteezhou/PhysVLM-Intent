<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®é‡‡é›†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .mode-switcher {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .mode-btn {
            padding: 12px 35px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .mode-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 25px;
            color: #2c3e50;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #667eea, #764ba2) 1;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #0d7a70 0%, #2dd169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d12a3d 0%, #e04a2f 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e07be8 0%, #e3455a 100%);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 700;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        tbody tr:nth-child(even):hover {
            background: #f1f3f5;
        }

        #template-form,
        #scene-form {
            display: none;
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #e1e8ed;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #template-form h3,
        #scene-form h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .status-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .collection-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .collection-item:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }

        .collection-content {
            display: flex;
            flex-direction: column;
        }

        .video-preview-panel {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .video-preview-panel h4 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: #495057;
            text-align: center;
        }

        .video-preview-container {
            width: 100%;
            height: 220px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .video-preview-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-preview-container .no-video {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #adb5bd;
            font-size: 0.9em;
        }

        .video-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .video-control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .video-control-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .video-control-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .video-info-text {
            font-size: 0.8em;
            color: #6c757d;
            text-align: center;
            margin-top: 5px;
        }

        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .collection-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .collection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .info-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .video-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .video-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .video-preview {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .video-card:hover .video-preview video {
            transform: scale(1.05);
        }

        .video-info {
            padding: 18px;
        }

        .video-name {
            font-weight: 700;
            margin-bottom: 8px;
            word-break: break-all;
            color: #2c3e50;
        }

        .video-meta {
            font-size: 0.85em;
            color: #6c757d;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 35px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.5em;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f8f9fa;
        }

        .modal-close:hover {
            color: #2c3e50;
            background: #e9ecef;
            transform: rotate(90deg);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .badge-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .create-collection-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-panel {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
        }

        .info-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .info-item-panel {
            margin-bottom: 20px;
        }

        .info-item-panel:last-child {
            margin-bottom: 0;
        }

        .info-item-panel .label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .info-item-panel .content {
            color: #6c757d;
            line-height: 1.6;
            padding: 10px;
            background: white;
            border-radius: 5px;
            min-height: 60px;
        }

        .info-item-panel .content.empty {
            color: #adb5bd;
            font-style: italic;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .mode-switcher {
                flex-direction: column;
                align-items: center;
            }

            .mode-btn {
                width: 100%;
                max-width: 300px;
            }

            .collection-info {
                grid-template-columns: 1fr;
            }

            .collection-item {
                grid-template-columns: 1fr;
            }

            .video-preview-panel {
                margin-top: 20px;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .create-collection-wrapper {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¹ æ•°æ®é‡‡é›†å·¥å…·</h1>
            <p>ç®¡ç†å‘˜æ¨¡å¼ï¼šç®¡ç†æŒ‡ä»¤æ¨¡æ¿å’Œåœºæ™¯ç±»å‹ | é‡‡é›†æ¨¡å¼ï¼šåˆ›å»ºé‡‡é›†ä»»åŠ¡å¹¶ç®¡ç†è§†é¢‘æ•°æ®</p>
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('admin')">ğŸ‘¤ ç®¡ç†å‘˜æ¨¡å¼</button>
                <button class="mode-btn" onclick="switchMode('collection')">ğŸ“¥ é‡‡é›†æ¨¡å¼</button>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜æ¨¡å¼ -->
        <div id="admin-section" class="content-section active">
            <div class="card">
                <h2 class="section-title">ğŸ“‹ æŒ‡ä»¤æ¨¡æ¿ç®¡ç†</h2>
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="showTemplateForm()">â• æ–°å»ºæŒ‡ä»¤æ¨¡æ¿</button>
                </div>

                <div id="template-form" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
                    <h3>åˆ›å»º/ç¼–è¾‘æŒ‡ä»¤æ¨¡æ¿</h3>
                    <div class="form-group">
                        <label>æŒ‡ä»¤æ¨¡æ¿ *</label>
                        <input type="text" id="template-name" placeholder="ä¾‹å¦‚ï¼šæŠ“å–çº¢è‰²ç‰©ä½“">
                    </div>
                    <div class="form-group">
                        <label>åœºæ™¯ç±»å‹ *</label>
                        <select id="template-scene-type">
                            <option value="">è¯·é€‰æ‹©åœºæ™¯ç±»å‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡æ•°é‡ *</label>
                        <input type="number" id="template-target-count" min="1" placeholder="ä¾‹å¦‚ï¼š10">
                    </div>
                    <div class="form-group">
                        <label>ä»»åŠ¡è¯´æ˜</label>
                        <textarea id="template-description" placeholder="è¯¦ç»†è¯´æ˜é‡‡é›†è¦æ±‚å’Œæ³¨æ„äº‹é¡¹"></textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" onclick="saveTemplate()">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn btn-warning" onclick="cancelTemplateForm()">å–æ¶ˆ</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="templates-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>æŒ‡ä»¤æ¨¡æ¿</th>
                                <th>åœºæ™¯ç±»å‹</th>
                                <th>ç›®æ ‡æ•°é‡</th>
                                <th>ä»»åŠ¡è¯´æ˜</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="templates-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">ğŸ¬ åœºæ™¯ç±»å‹ç®¡ç†</h2>
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="showSceneForm()">â• æ–°å»ºåœºæ™¯ç±»å‹</button>
                </div>

                <div id="scene-form" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
                    <h3>åˆ›å»º/ç¼–è¾‘åœºæ™¯ç±»å‹</h3>
                    <div class="form-group">
                        <label>åœºæ™¯åç§° *</label>
                        <input type="text" id="scene-name" placeholder="ä¾‹å¦‚ï¼šå®¤å†…ç¯å¢ƒ">
                    </div>
                    <div class="form-group">
                        <label>åœºæ™¯æè¿° *</label>
                        <textarea id="scene-description" placeholder="è¯¦ç»†æè¿°åœºæ™¯ç‰¹ç‚¹"></textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" onclick="saveScene()">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn btn-warning" onclick="cancelSceneForm()">å–æ¶ˆ</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="scenes-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åœºæ™¯åç§°</th>
                                <th>åœºæ™¯æè¿°</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="scenes-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- é‡‡é›†æ¨¡å¼ -->
        <div id="collection-section" class="content-section">
            <div class="card">
                <h2 class="section-title">ğŸ“¥ åˆ›å»ºé‡‡é›†ä»»åŠ¡</h2>
                
                <div class="create-collection-wrapper">
                    <div>
                        <div class="form-group">
                            <label>é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿ *</label>
                            <select id="collection-template" onchange="updateCollectionInfo()">
                                <option value="">è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>é€‰æ‹©åœºæ™¯ç±»å‹ *</label>
                            <select id="collection-scene" onchange="updateCollectionInfo()">
                                <option value="">è¯·é€‰æ‹©åœºæ™¯ç±»å‹</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-success" onclick="createCollection()">âœ… åˆ›å»ºé‡‡é›†ä»»åŠ¡</button>
                        </div>
                    </div>
                    
                    <div class="info-panel">
                        <h3>ğŸ“‹ ä»»åŠ¡è¯´æ˜</h3>
                        <div id="template-info" class="info-item-panel">
                            <div class="label">æŒ‡ä»¤æ¨¡æ¿ï¼š</div>
                            <div class="content empty">è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿</div>
                        </div>
                        <div id="scene-info" class="info-item-panel">
                            <div class="label">åœºæ™¯ç±»å‹ï¼š</div>
                            <div class="content empty">è¯·é€‰æ‹©åœºæ™¯ç±»å‹</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">ğŸ“Š é‡‡é›†ä»»åŠ¡åˆ—è¡¨</h2>
                <div id="collections-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½é‡‡é›†ä»»åŠ¡...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <!-- è§†é¢‘é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeVideoModal()">&times;</span>
            <h2 id="modal-video-title"></h2>
            <video id="modal-video" controls style="width: 100%; margin-top: 20px;"></video>
            <div id="modal-video-info" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let currentMode = 'admin';
        let editingTemplateId = null;
        let editingSceneId = null;
        let templates = [];
        let scenes = [];
        let collections = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadTemplates();
            loadScenes();
            loadCollections();
        });

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            
            if (mode === 'admin') {
                document.querySelector('.mode-btn[onclick="switchMode(\'admin\')"]').classList.add('active');
                document.getElementById('admin-section').classList.add('active');
            } else {
                document.querySelector('.mode-btn[onclick="switchMode(\'collection\')"]').classList.add('active');
                document.getElementById('collection-section').classList.add('active');
                loadCollections();
            }
        }

        // ==================== ç®¡ç†å‘˜æ¨¡å¼åŠŸèƒ½ ====================

        async function loadTemplates() {
            try {
                const response = await fetch('/api/admin/templates');
                const data = await response.json();
                if (data.success) {
                    templates = data.templates;
                    renderTemplates();
                    updateTemplateSelects();
                }
            } catch (error) {
                showStatus('åŠ è½½æŒ‡ä»¤æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadScenes() {
            try {
                const response = await fetch('/api/admin/scenes');
                const data = await response.json();
                if (data.success) {
                    scenes = data.scenes;
                    renderScenes();
                    updateSceneSelects();
                    updateTemplateSelects(); // åŒæ—¶æ›´æ–°æŒ‡ä»¤æ¨¡æ¿è¡¨å•ä¸­çš„åœºæ™¯ç±»å‹ä¸‹æ‹‰æ¡†
                }
            } catch (error) {
                showStatus('åŠ è½½åœºæ™¯ç±»å‹å¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderTemplates() {
            const tbody = document.getElementById('templates-tbody');
            tbody.innerHTML = '';
            
            templates.forEach(template => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${template.id}</td>
                    <td>${template.name}</td>
                    <td>${template.scene_type}</td>
                    <td>${template.target_count}</td>
                    <td>${template.description || '-'}</td>
                    <td>${template.created_at}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editTemplate(${template.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteTemplate(${template.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderScenes() {
            const tbody = document.getElementById('scenes-tbody');
            tbody.innerHTML = '';
            
            scenes.forEach(scene => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${scene.id}</td>
                    <td>${scene.name}</td>
                    <td>${scene.description}</td>
                    <td>${scene.created_at}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editScene(${scene.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteScene(${scene.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showTemplateForm() {
            document.getElementById('template-form').style.display = 'block';
            editingTemplateId = null;
            clearTemplateForm();
            // æ˜¾ç¤ºè¡¨å•æ—¶åˆ·æ–°åœºæ™¯ç±»å‹ä¸‹æ‹‰æ¡†
            updateTemplateSelects();
        }

        function cancelTemplateForm() {
            document.getElementById('template-form').style.display = 'none';
            editingTemplateId = null;
            clearTemplateForm();
        }

        function clearTemplateForm() {
            document.getElementById('template-name').value = '';
            document.getElementById('template-scene-type').value = '';
            document.getElementById('template-target-count').value = '';
            document.getElementById('template-description').value = '';
        }

        function editTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;
            
            editingTemplateId = id;
            // å…ˆåˆ·æ–°åœºæ™¯ç±»å‹ä¸‹æ‹‰æ¡†ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„åœºæ™¯ç±»å‹
            updateTemplateSelects();
            // ç„¶åè®¾ç½®è¡¨å•å€¼
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-scene-type').value = template.scene_type;
            document.getElementById('template-target-count').value = template.target_count;
            document.getElementById('template-description').value = template.description || '';
            document.getElementById('template-form').style.display = 'block';
        }

        async function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            const sceneType = document.getElementById('template-scene-type').value.trim();
            const targetCount = document.getElementById('template-target-count').value.trim();
            const description = document.getElementById('template-description').value.trim();

            if (!name || !sceneType || !targetCount) {
                showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }

            try {
                const url = editingTemplateId 
                    ? `/api/admin/templates/${editingTemplateId}`
                    : '/api/admin/templates';
                
                const method = editingTemplateId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name, scene_type: sceneType,
                        target_count: targetCount, description
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('æŒ‡ä»¤æ¨¡æ¿ä¿å­˜æˆåŠŸ', 'success');
                    cancelTemplateForm();
                    loadTemplates();
                } else {
                    showStatus('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŒ‡ä»¤æ¨¡æ¿å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/admin/templates/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('æŒ‡ä»¤æ¨¡æ¿åˆ é™¤æˆåŠŸ', 'success');
                    loadTemplates();
                } else {
                    showStatus('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showSceneForm() {
            document.getElementById('scene-form').style.display = 'block';
            editingSceneId = null;
            clearSceneForm();
        }

        function cancelSceneForm() {
            document.getElementById('scene-form').style.display = 'none';
            editingSceneId = null;
            clearSceneForm();
        }

        function clearSceneForm() {
            document.getElementById('scene-name').value = '';
            document.getElementById('scene-description').value = '';
        }

        function editScene(id) {
            const scene = scenes.find(s => s.id === id);
            if (!scene) return;
            
            editingSceneId = id;
            document.getElementById('scene-name').value = scene.name;
            document.getElementById('scene-description').value = scene.description;
            document.getElementById('scene-form').style.display = 'block';
        }

        async function saveScene() {
            const name = document.getElementById('scene-name').value.trim();
            const description = document.getElementById('scene-description').value.trim();

            if (!name || !description) {
                showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }

            try {
                const url = editingSceneId 
                    ? `/api/admin/scenes/${editingSceneId}`
                    : '/api/admin/scenes';
                
                const method = editingSceneId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('åœºæ™¯ç±»å‹ä¿å­˜æˆåŠŸ', 'success');
                    cancelSceneForm();
                    loadScenes();
                } else {
                    showStatus('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteScene(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœºæ™¯ç±»å‹å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/admin/scenes/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('åœºæ™¯ç±»å‹åˆ é™¤æˆåŠŸ', 'success');
                    loadScenes();
                } else {
                    showStatus('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateTemplateSelects() {
            const selects = ['template-scene-type', 'collection-template'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = selectId === 'collection-template' 
                        ? '<option value="">è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿</option>'
                        : '<option value="">è¯·é€‰æ‹©åœºæ™¯ç±»å‹</option>';
                    
                    if (selectId === 'collection-template') {
                        templates.forEach(t => {
                            const option = document.createElement('option');
                            option.value = t.id;
                            option.textContent = `${t.name} (${t.scene_type})`;
                            select.appendChild(option);
                        });
                    } else {
                        scenes.forEach(s => {
                            const option = document.createElement('option');
                            option.value = s.name;
                            option.textContent = s.name;
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue;
                    // å¦‚æœæ˜¯é‡‡é›†æ¨¡æ¿é€‰æ‹©æ¡†ä¸”æœ‰é€‰æ‹©å€¼ï¼Œæ›´æ–°è¯´æ˜ä¿¡æ¯
                    if (selectId === 'collection-template' && currentValue) {
                        updateCollectionInfo();
                    }
                }
            });
        }

        function updateSceneSelects() {
            const select = document.getElementById('collection-scene');
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">è¯·é€‰æ‹©åœºæ™¯ç±»å‹</option>';
                scenes.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
                // å¦‚æœå½“å‰æœ‰é€‰æ‹©å€¼ï¼Œæ›´æ–°è¯´æ˜ä¿¡æ¯
                if (currentValue) {
                    updateCollectionInfo();
                }
            }
        }

        // ==================== é‡‡é›†æ¨¡å¼åŠŸèƒ½ ====================

        function updateCollectionInfo() {
            // æ›´æ–°æŒ‡ä»¤æ¨¡æ¿è¯´æ˜
            const templateId = document.getElementById('collection-template').value;
            const templateInfoDiv = document.getElementById('template-info').querySelector('.content');
            
            if (templateId) {
                const template = templates.find(t => t.id === parseInt(templateId));
                if (template) {
                    templateInfoDiv.className = 'content';
                    templateInfoDiv.innerHTML = `
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">${template.name}</div>
                        <div style="margin-bottom: 8px;"><strong>åœºæ™¯ç±»å‹ï¼š</strong>${template.scene_type}</div>
                        <div style="margin-bottom: 8px;"><strong>ç›®æ ‡æ•°é‡ï¼š</strong>${template.target_count}</div>
                        ${template.description ? `<div><strong>ä»»åŠ¡è¯´æ˜ï¼š</strong><br>${template.description}</div>` : ''}
                    `;
                } else {
                    templateInfoDiv.className = 'content empty';
                    templateInfoDiv.textContent = 'è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿';
                }
            } else {
                templateInfoDiv.className = 'content empty';
                templateInfoDiv.textContent = 'è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿';
            }
            
            // æ›´æ–°åœºæ™¯ç±»å‹è¯´æ˜
            const sceneId = document.getElementById('collection-scene').value;
            const sceneInfoDiv = document.getElementById('scene-info').querySelector('.content');
            
            if (sceneId) {
                const scene = scenes.find(s => s.id === parseInt(sceneId));
                if (scene) {
                    sceneInfoDiv.className = 'content';
                    sceneInfoDiv.innerHTML = `
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">${scene.name}</div>
                        <div>${scene.description}</div>
                    `;
                } else {
                    sceneInfoDiv.className = 'content empty';
                    sceneInfoDiv.textContent = 'è¯·é€‰æ‹©åœºæ™¯ç±»å‹';
                }
            } else {
                sceneInfoDiv.className = 'content empty';
                sceneInfoDiv.textContent = 'è¯·é€‰æ‹©åœºæ™¯ç±»å‹';
            }
        }

        async function createCollection() {
            const templateId = document.getElementById('collection-template').value;
            const sceneId = document.getElementById('collection-scene').value;

            if (!templateId || !sceneId) {
                showStatus('è¯·é€‰æ‹©æŒ‡ä»¤æ¨¡æ¿å’Œåœºæ™¯ç±»å‹', 'error');
                return;
            }

            try {
                const response = await fetch('/api/collection/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        template_id: parseInt(templateId),
                        scene_id: parseInt(sceneId)
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus(`é‡‡é›†ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼æ–‡ä»¶å¤¹è·¯å¾„: ${data.collection.folder_path}`, 'success');
                    document.getElementById('collection-template').value = '';
                    document.getElementById('collection-scene').value = '';
                    updateCollectionInfo(); // æ¸…ç©ºè¯´æ˜ä¿¡æ¯
                    loadCollections();
                } else {
                    showStatus('åˆ›å»ºå¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadCollections() {
            try {
                const container = document.getElementById('collections-container');
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½é‡‡é›†ä»»åŠ¡...</p></div>';
                
                const response = await fetch('/api/collection/list');
                const data = await response.json();
                
                if (data.success) {
                    collections = data.collections;
                    renderCollections();
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #e74c3c;">åŠ è½½å¤±è´¥: ' + data.error + '</p>';
                }
            } catch (error) {
                document.getElementById('collections-container').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c;">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }

        function renderCollections() {
            const container = document.getElementById('collections-container');
            
            if (collections.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">æš‚æ— é‡‡é›†ä»»åŠ¡</p>';
                return;
            }

            container.innerHTML = '';
            
            collections.forEach(collection => {
                const progress = collection.target_count > 0 
                    ? Math.round((collection.current_count / collection.target_count) * 100)
                    : 0;
                
                const progressColor = progress >= 100 ? 'success' : progress >= 50 ? 'warning' : 'info';
                
                const div = document.createElement('div');
                div.className = 'collection-item';
                div.id = `collection-${collection.id}`;
                
                // å‡†å¤‡è§†é¢‘åˆ—è¡¨
                const videos = collection.videos || [];
                const videoIndex = 0; // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªè§†é¢‘
                
                div.innerHTML = `
                    <div class="collection-content">
                        <div class="collection-header">
                            <div class="collection-title">${collection.template_name} - ${collection.scene_name}</div>
                            <div>
                                <span class="badge badge-${collection.status === 'completed' ? 'success' : 'info'}">
                                    ${collection.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                </span>
                            </div>
                        </div>
                        <div class="collection-info">
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <div class="info-label">æ–‡ä»¶å¤¹è·¯å¾„</div>
                                <div class="info-value" style="word-break: break-all; font-size: 0.9em;">${collection.folder_path}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ç›®æ ‡æ•°é‡</div>
                                <div class="info-value">${collection.target_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å½“å‰æ•°é‡</div>
                                <div class="info-value">${collection.current_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å®Œæˆåº¦</div>
                                <div class="info-value">${progress}%</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                                <div class="info-value">${collection.created_at}</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
                                ${collection.current_count} / ${collection.target_count}
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="scanCollection(${collection.id})">ğŸ”„ æ‰«ææ–‡ä»¶å¤¹</button>
                            ${collection.status !== 'completed' ? 
                                `<button class="btn btn-warning" onclick="completeCollection(${collection.id})">âœ… å®Œæˆä»»åŠ¡</button>` 
                                : ''}
                            <button class="btn btn-danger" onclick="deleteCollection(${collection.id})">ğŸ—‘ï¸ åˆ é™¤ä»»åŠ¡</button>
                        </div>
                    </div>
                    <div class="video-preview-panel">
                        <h4>ğŸ“¹ è§†é¢‘é¢„è§ˆ</h4>
                        <div class="video-preview-container" id="video-preview-${collection.id}">
                            ${videos.length > 0 ? 
                                `<video id="video-player-${collection.id}" src="/videos/${encodeURIComponent(videos[0].relative_path || videos[0].filename)}" preload="metadata"></video>` :
                                `<div class="no-video">æš‚æ— è§†é¢‘æ–‡ä»¶</div>`
                            }
                        </div>
                        <div class="video-controls">
                            <button class="video-control-btn" onclick="playPauseVideo(${collection.id})" id="play-btn-${collection.id}" ${videos.length === 0 ? 'disabled' : ''}>
                                â–¶ï¸ æ’­æ”¾
                            </button>
                            <button class="video-control-btn" onclick="prevVideo(${collection.id})" id="prev-btn-${collection.id}" ${videos.length === 0 ? 'disabled' : ''}>
                                â®ï¸ ä¸Šä¸€æ¡
                            </button>
                            <button class="video-control-btn" onclick="nextVideo(${collection.id})" id="next-btn-${collection.id}" ${videos.length === 0 ? 'disabled' : ''}>
                                â­ï¸ ä¸‹ä¸€æ¡
                            </button>
                        </div>
                        <div class="video-info-text" id="video-info-${collection.id}">
                            ${videos.length > 0 ? `1 / ${videos.length}` : '0 / 0'}
                        </div>
                    </div>
                `;
                
                // å­˜å‚¨è§†é¢‘åˆ—è¡¨åˆ°å…ƒç´ ä¸Š
                div.dataset.videos = JSON.stringify(videos);
                div.dataset.currentIndex = '0';
                
                container.appendChild(div);
            });
        }

        async function scanCollection(collectionId) {
            try {
                showStatus('æ­£åœ¨æ‰«ææ–‡ä»¶å¤¹...', 'info');
                const response = await fetch(`/api/collection/${collectionId}/scan`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showStatus(`æ‰«æå®Œæˆï¼æ‰¾åˆ° ${data.count} ä¸ªè§†é¢‘æ–‡ä»¶`, 'success');
                    loadCollections();
                } else {
                    showStatus('æ‰«æå¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('æ‰«æå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function viewCollection(collectionId) {
            try {
                const response = await fetch(`/api/collection/${collectionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const collection = data.collection;
                    const modal = document.getElementById('video-modal');
                    const modalContent = modal.querySelector('.modal-content');
                    
                    modalContent.innerHTML = `
                        <span class="modal-close" onclick="closeVideoModal()">&times;</span>
                        <h2>${collection.template_name} - ${collection.scene_name}</h2>
                        <p><strong>æ–‡ä»¶å¤¹è·¯å¾„:</strong> ${collection.folder_path}</p>
                        <p><strong>è§†é¢‘æ•°é‡:</strong> ${collection.current_count} / ${collection.target_count}</p>
                        <div class="video-grid" id="modal-video-grid"></div>
                    `;
                    
                    const grid = document.getElementById('modal-video-grid');
                    if (collection.videos && collection.videos.length > 0) {
                        collection.videos.forEach(video => {
                            const card = document.createElement('div');
                            card.className = 'video-card';
                            const videoPath = encodeURIComponent(video.relative_path || video.filename);
                            card.innerHTML = `
                                <div class="video-preview">
                                    <video src="/videos/${videoPath}" 
                                           onclick="playVideo('/videos/${videoPath}', '${video.filename.replace(/'/g, "\\'")}')"
                                           style="cursor: pointer;"
                                           preload="metadata"></video>
                                </div>
                                <div class="video-info">
                                    <div class="video-name">${video.filename}</div>
                                    <div class="video-meta">
                                        å¤§å°: ${video.size_mb} MB<br>
                                        ä¿®æ”¹æ—¶é—´: ${video.modified_time}
                                    </div>
                                </div>
                            `;
                            grid.appendChild(card);
                        });
                    } else {
                        grid.innerHTML = '<p style="text-align: center; color: #6c757d;">æš‚æ— è§†é¢‘æ–‡ä»¶</p>';
                    }
                    
                    modal.classList.add('active');
                } else {
                    showStatus('åŠ è½½å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function playVideo(src, filename) {
            const modal = document.getElementById('video-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <span class="modal-close" onclick="closeVideoModal()">&times;</span>
                <h2>${filename}</h2>
                <video id="modal-video" controls autoplay style="width: 100%; margin-top: 20px;">
                    <source src="${src}" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
            `;
        }

        function closeVideoModal() {
            document.getElementById('video-modal').classList.remove('active');
        }

        async function completeCollection(collectionId) {
            if (!confirm('ç¡®å®šè¦å®Œæˆè¿™ä¸ªé‡‡é›†ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/collection/${collectionId}/complete`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('é‡‡é›†ä»»åŠ¡å·²å®Œæˆ', 'success');
                    loadCollections();
                } else {
                    showStatus('æ“ä½œå¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteCollection(collectionId) {
            const collection = collections.find(c => c.id === collectionId);
            const collectionName = collection ? `${collection.template_name} - ${collection.scene_name}` : 'è¯¥ä»»åŠ¡';
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‡‡é›†ä»»åŠ¡ "${collectionName}" å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»»åŠ¡è®°å½•å’Œç›¸å…³æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            try {
                showStatus('æ­£åœ¨åˆ é™¤ä»»åŠ¡...', 'info');
                const response = await fetch(`/api/collection/${collectionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('é‡‡é›†ä»»åŠ¡åŠç›¸å…³æ•°æ®å·²åˆ é™¤', 'success');
                    loadCollections();
                } else {
                    showStatus('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== è§†é¢‘æ§åˆ¶åŠŸèƒ½ ====================

        function getCollectionVideos(collectionId) {
            const collectionElement = document.getElementById(`collection-${collectionId}`);
            if (!collectionElement) return [];
            
            try {
                const videosJson = collectionElement.dataset.videos;
                return videosJson ? JSON.parse(videosJson) : [];
            } catch (e) {
                return [];
            }
        }

        function getCurrentVideoIndex(collectionId) {
            const collectionElement = document.getElementById(`collection-${collectionId}`);
            if (!collectionElement) return 0;
            
            return parseInt(collectionElement.dataset.currentIndex || '0');
        }

        function setCurrentVideoIndex(collectionId, index) {
            const collectionElement = document.getElementById(`collection-${collectionId}`);
            if (collectionElement) {
                collectionElement.dataset.currentIndex = index.toString();
            }
        }

        function updateVideoDisplay(collectionId, videoIndex) {
            const videos = getCollectionVideos(collectionId);
            if (videos.length === 0) return;
            
            if (videoIndex < 0) videoIndex = 0;
            if (videoIndex >= videos.length) videoIndex = videos.length - 1;
            
            const video = videos[videoIndex];
            const videoPlayer = document.getElementById(`video-player-${collectionId}`);
            const videoContainer = document.getElementById(`video-preview-${collectionId}`);
            const videoInfo = document.getElementById(`video-info-${collectionId}`);
            const prevBtn = document.getElementById(`prev-btn-${collectionId}`);
            const nextBtn = document.getElementById(`next-btn-${collectionId}`);
            
            if (videoPlayer && video) {
                videoPlayer.src = `/videos/${encodeURIComponent(video.relative_path || video.filename)}`;
                videoPlayer.load();
            } else if (!videoPlayer && videoContainer && video) {
                // å¦‚æœæ²¡æœ‰videoå…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                videoContainer.innerHTML = `<video id="video-player-${collectionId}" src="/videos/${encodeURIComponent(video.relative_path || video.filename)}" preload="metadata"></video>`;
            }
            
            if (videoInfo) {
                videoInfo.textContent = `${videoIndex + 1} / ${videos.length}`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = videoIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.disabled = videoIndex === videos.length - 1;
            }
            
            setCurrentVideoIndex(collectionId, videoIndex);
        }

        function playPauseVideo(collectionId) {
            const videoPlayer = document.getElementById(`video-player-${collectionId}`);
            const playBtn = document.getElementById(`play-btn-${collectionId}`);
            
            if (!videoPlayer) return;
            
            if (videoPlayer.paused) {
                videoPlayer.play();
                if (playBtn) {
                    playBtn.innerHTML = 'â¸ï¸ æš‚åœ';
                }
            } else {
                videoPlayer.pause();
                if (playBtn) {
                    playBtn.innerHTML = 'â–¶ï¸ æ’­æ”¾';
                }
            }
        }

        function prevVideo(collectionId) {
            const currentIndex = getCurrentVideoIndex(collectionId);
            if (currentIndex > 0) {
                const videoPlayer = document.getElementById(`video-player-${collectionId}`);
                if (videoPlayer) {
                    videoPlayer.pause();
                }
                const playBtn = document.getElementById(`play-btn-${collectionId}`);
                if (playBtn) {
                    playBtn.innerHTML = 'â–¶ï¸ æ’­æ”¾';
                }
                updateVideoDisplay(collectionId, currentIndex - 1);
            }
        }

        function nextVideo(collectionId) {
            const videos = getCollectionVideos(collectionId);
            const currentIndex = getCurrentVideoIndex(collectionId);
            if (currentIndex < videos.length - 1) {
                const videoPlayer = document.getElementById(`video-player-${collectionId}`);
                if (videoPlayer) {
                    videoPlayer.pause();
                }
                const playBtn = document.getElementById(`play-btn-${collectionId}`);
                if (playBtn) {
                    playBtn.innerHTML = 'â–¶ï¸ æ’­æ”¾';
                }
                updateVideoDisplay(collectionId, currentIndex + 1);
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>

