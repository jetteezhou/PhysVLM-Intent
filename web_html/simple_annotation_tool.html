<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“æ ‡æ³¨å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .header h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        .config-item input,
        .config-item select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 280px 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .video-list-panel, .stats-panel {
                max-height: 300px;
            }
        }

        .video-list-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .video-list-panel h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-search {
            margin-bottom: 15px;
        }

        .video-search input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        .video-stats {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .stats-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .stats-panel h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .stat-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
        }

        .shortcuts-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shortcuts-panel h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85em;
            color: #6c757d;
        }

        .shortcut-key {
            background: #e1e8ed;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
        }

        .video-item {
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .video-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .video-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #e7f0ff 0%, #d4e5ff 100%);
        }

        .video-item.annotated {
            border-left: 4px solid #2ed573;
        }

        .video-item.unannotated {
            border-left: 4px solid #ff4757;
        }

        .video-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .video-item-status {
            font-size: 0.85em;
            color: #6c757d;
        }

        .annotation-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-preview-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .video-preview-section h2 {
            color: #2c3e50;
            font-size: 1.2em;
        }

        .video-player-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            max-height: 400px;
            display: block;
        }

        .video-controls-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .video-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .video-controls input[type="range"] {
            flex: 1;
        }

        .asr-result-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
        }

        .asr-result-section label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .asr-result-text {
            min-height: 40px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .asr-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
        }

        .spinner-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .asr-error {
            color: #dc3545;
            font-size: 0.9em;
        }

        .image-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-section h2 {
            color: #2c3e50;
            font-size: 1.2em;
        }

        .image-container {
            position: relative;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            overflow: auto;
            background: #f8f9fa;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #last-frame-image {
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
        }

        .point-marker {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .point-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }

        .point-marker.selected {
            transform: translate(-50%, -50%) scale(1.4);
            border-width: 4px;
            z-index: 20;
        }

        .point-marker.editing {
            cursor: move;
            border-width: 4px;
            animation: editing-pulse 1.5s infinite;
        }

        @keyframes editing-pulse {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 8px rgba(102, 126, 234, 0);
            }
        }

        .point-marker.dragging {
            opacity: 0.8;
            z-index: 30;
        }

        .point-marker.object-0 {
            background-color: #ff4757;
        }

        .point-marker.object-1 {
            background-color: #2ed573;
        }

        .point-marker.object-2 {
            background-color: #3742fa;
        }

        .point-marker.object-3 {
            background-color: #ffa502;
        }

        .point-marker.object-4 {
            background-color: #5f27cd;
        }

        .point-marker.saved-marker {
            opacity: 0.7;
            border-width: 2px;
        }

        .point-marker.editing-marker {
            opacity: 1;
            border-width: 3px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .point-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -8px;
        }

        .objects-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .object-item {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .object-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .object-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .object-item-name {
            font-weight: 600;
            flex: 1;
        }

        .object-item-points {
            font-size: 0.85em;
            color: #6c757d;
            margin-right: 10px;
        }

        .object-item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            padding: 5px 10px;
            font-size: 0.85em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #ff4757;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            display: none;
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .status-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ç®€æ˜“æ ‡æ³¨å·¥å…·</h1>
            <div class="config-section">
                <div class="config-item">
                    <label>é€‰æ‹©æ ‡æ³¨æ–‡ä»¶å¤¹ï¼š</label>
                    <input type="text" id="folder-path" placeholder="è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„æˆ–ç‚¹å‡»æµè§ˆé€‰æ‹©" />
                    <input type="file" id="folder-selector" webkitdirectory directory multiple style="display: none;" />
                </div>
                <div class="config-item">
                    <button class="btn btn-primary" onclick="selectFolder()">ğŸ“ æµè§ˆæ–‡ä»¶å¤¹</button>
                </div>
                <div class="config-item">
                    <label>ä»»åŠ¡æŒ‡ä»¤æ¨¡æ¿ï¼š</label>
                    <input type="text" id="task-template" placeholder="ä¾‹å¦‚ï¼šæŠŠè¿™ä¸ªæ”¾åˆ°é‚£ä¸ªçš„å³è¾¹" />
                </div>
                <div class="config-item">
                    <label>åœºæ™¯ï¼š</label>
                    <input type="text" id="scene" placeholder="ä¾‹å¦‚ï¼šåŠå…¬ç¯å¢ƒ" />
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="loadVideos()">ğŸ”„ åŠ è½½è§†é¢‘</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div id="status-message" class="status-message"></div>
        </div>

        <div class="main-content" id="main-content" style="display: none;">
            <div class="video-list-panel">
                <h2>ğŸ“¹ è§†é¢‘åˆ—è¡¨ <span id="video-count" style="font-size: 0.7em; color: #6c757d;"></span></h2>
                <div class="video-search">
                    <input type="text" id="video-search" placeholder="ğŸ” æœç´¢è§†é¢‘..." oninput="filterVideos()" />
                </div>
                <div class="video-stats" id="video-stats"></div>
                <div id="video-list"></div>
            </div>

            <div class="annotation-panel">
                <div class="video-preview-section">
                    <h2>ğŸ¬ è§†é¢‘é¢„è§ˆ</h2>
                    <div class="video-player-container">
                        <video id="video-player" class="video-player" controls></video>
                    </div>
                    <div class="video-controls-row">
                        <div class="video-controls">
                            <label>æ’­æ”¾é€Ÿåº¦ï¼š</label>
                            <select id="playback-speed" onchange="changePlaybackSpeed()">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1">1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5" selected>1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                        <div class="asr-result-section">
                            <label>ğŸ¤ ASRè¯†åˆ«ç»“æœï¼š</label>
                            <div id="asr-result" class="asr-result-text">
                                <div class="asr-loading" id="asr-loading" style="display: none;">
                                    <span class="spinner-small"></span>
                                    <span>æ­£åœ¨è¯†åˆ«ä¸­...</span>
                                </div>
                                <div id="asr-text-content" style="display: none;"></div>
                                <div id="asr-error" class="asr-error" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="image-section">
                    <h2>ğŸ–¼ï¸ æœ€åä¸€å¸§æ ‡æ³¨</h2>
                    <div class="image-container" id="image-container">
                        <img id="last-frame-image" src="" alt="æœ€åä¸€å¸§" />
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="addObject()">â• æ·»åŠ ç›®æ ‡å¯¹è±¡ (A)</button>
                        <button class="btn btn-primary" onclick="addPlacementSpace()">ğŸ“ æ·»åŠ æ”¾ç½®ç©ºé—´ (W)</button>
                        <button class="btn btn-success" onclick="saveCurrentObject()">ğŸ’¾ ä¿å­˜ç›®æ ‡ (S)</button>
                        <button class="btn btn-warning" onclick="clearCurrentObject()">ğŸ—‘ï¸ æ¸…é™¤å½“å‰å¯¹è±¡ (C)</button>
                        <button class="btn btn-success" id="save-editing-btn" onclick="saveEditingObject()" style="display: none;">ğŸ’¾ ä¿å­˜ç¼–è¾‘</button>
                        <button class="btn btn-warning" id="cancel-editing-btn" onclick="cancelEditingObject()" style="display: none;">âŒ å–æ¶ˆç¼–è¾‘ (Esc)</button>
                        <button class="btn btn-success" onclick="saveAnnotations()">ğŸ’¾ ä¿å­˜æ ‡æ³¨ (Ctrl+S)</button>
                        <button class="btn btn-warning" onclick="markAsInvalidVideo()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">âŒ æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘</button>
                    </div>
                    <div class="objects-list" id="objects-list"></div>
                </div>
            </div>

            <div class="stats-panel">
                <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="stat-item">
                    <div class="stat-label">å½“å‰è§†é¢‘</div>
                    <div class="stat-value" id="stat-current-video">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å·²æ ‡æ³¨å¯¹è±¡</div>
                    <div class="stat-value" id="stat-objects-count">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ ‡æ³¨ç‚¹æ€»æ•°</div>
                    <div class="stat-value" id="stat-points-count">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ ‡æ³¨è¿›åº¦</div>
                    <div class="stat-value" id="stat-progress">0%</div>
                </div>
                <div class="shortcuts-panel">
                    <h3>âŒ¨ï¸ å¿«æ·é”®</h3>
                    <div class="shortcut-item">
                        <span>ä¿å­˜æ ‡æ³¨</span>
                        <span class="shortcut-key">Ctrl+S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>æ·»åŠ å¯¹è±¡</span>
                        <span class="shortcut-key">A</span>
                    </div>
                    <div class="shortcut-item">
                        <span>ä¿å­˜å½“å‰å¯¹è±¡</span>
                        <span class="shortcut-key">S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>æ¸…é™¤å½“å‰å¯¹è±¡</span>
                        <span class="shortcut-key">C</span>
                    </div>
                    <div class="shortcut-item">
                        <span>åˆ é™¤é€‰ä¸­ç‚¹</span>
                        <span class="shortcut-key">Delete</span>
                    </div>
                    <div class="shortcut-item">
                        <span>å–æ¶ˆç¼–è¾‘</span>
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-item">
                        <span>æ’¤é”€</span>
                        <span class="shortcut-key">Ctrl+Z</span>
                    </div>
                    <div class="shortcut-item">
                        <span>é‡åš</span>
                        <span class="shortcut-key">Ctrl+Y</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†...</p>
        </div>
    </div>

    <script>
        let videos = [];
        let filteredVideos = [];
        let currentVideoIndex = -1;
        let currentVideo = null;
        let annotations = {};
        let currentObjectIndex = -1;
        let currentObjectPoints = [];
        let currentObjectName = '';
        let savedObjects = []; // å·²ä¿å­˜çš„å¯¹è±¡åˆ—è¡¨
        let folderPath = '';
        let selectedPointIndex = -1; // å½“å‰é€‰ä¸­çš„ç‚¹ç´¢å¼•
        let selectedObjectIndex = -1; // å½“å‰é€‰ä¸­çš„å¯¹è±¡ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
        let editingObjectIndex = -1; // æ­£åœ¨ç¼–è¾‘çš„å¯¹è±¡ç´¢å¼•
        let editingObjectPoints = []; // æ­£åœ¨ç¼–è¾‘çš„å¯¹è±¡ç‚¹åˆ—è¡¨
        let history = []; // å†å²è®°å½•ç”¨äºæ’¤é”€/é‡åš
        let historyIndex = -1; // å½“å‰å†å²è®°å½•ç´¢å¼•
        let autoSaveTimer = null; // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        let draggedMarker = null; // æ­£åœ¨æ‹–åŠ¨çš„æ ‡è®°ç‚¹
        let dragOffset = { x: 0, y: 0 }; // æ‹–åŠ¨åç§»é‡
        let currentASRResult = null; // å½“å‰è§†é¢‘çš„ASRè¯†åˆ«ç»“æœï¼ˆåŒ…å«sentenceå’Œwordsï¼‰
        let currentObjectType = 'object'; // å½“å‰å¯¹è±¡çš„ç±»å‹ï¼š'object' æˆ– 'space'
        let globalTaskTemplate = ''; // å…¨å±€ä»»åŠ¡æ¨¡æ¿ï¼ˆä¿ç•™åœ¨åˆ‡æ¢è§†é¢‘æ—¶ï¼‰
        let globalScene = ''; // å…¨å±€åœºæ™¯ï¼ˆä¿ç•™åœ¨åˆ‡æ¢è§†é¢‘æ—¶ï¼‰

        // ç›‘å¬ä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯è¾“å…¥æ¡†çš„å˜åŒ–ï¼Œæ›´æ–°å…¨å±€å˜é‡
        document.addEventListener('DOMContentLoaded', () => {
            const taskTemplateInput = document.getElementById('task-template');
            const sceneInput = document.getElementById('scene');
            
            if (taskTemplateInput) {
                taskTemplateInput.addEventListener('input', () => {
                    globalTaskTemplate = taskTemplateInput.value.trim();
                });
            }
            
            if (sceneInput) {
                sceneInput.addEventListener('input', () => {
                    globalScene = sceneInput.value.trim();
                });
            }
        });

        // åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl+S ä¿å­˜æ ‡æ³¨
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAnnotations();
                return;
            }
            
            // Ctrl+Z æ’¤é”€
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
                return;
            }
            
            // Ctrl+Y æˆ– Ctrl+Shift+Z é‡åš
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                e.preventDefault();
                redo();
                return;
            }
            
            // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ï¼Œä¸å¤„ç†å…¶ä»–å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // A æ·»åŠ å¯¹è±¡
            if (e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                addObject();
                return;
            }
            
            // W æ·»åŠ æ”¾ç½®ç©ºé—´
            if (e.key === 'w' || e.key === 'W') {
                e.preventDefault();
                addPlacementSpace();
                return;
            }
            
            // S ä¿å­˜å½“å‰å¯¹è±¡
            if (e.key === 's' || e.key === 'S') {
                e.preventDefault();
                saveCurrentObject();
                return;
            }
            
            // C æ¸…é™¤å½“å‰å¯¹è±¡
            if (e.key === 'c' || e.key === 'C') {
                e.preventDefault();
                clearCurrentObject();
                return;
            }
            
            // Delete åˆ é™¤é€‰ä¸­çš„ç‚¹
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                if (selectedPointIndex >= 0) {
                    deleteSelectedPoint();
                }
                return;
            }
            
            // Escape å–æ¶ˆç¼–è¾‘æ¨¡å¼
            if (e.key === 'Escape') {
                if (editingObjectIndex >= 0) {
                    cancelEditingObject();
                }
                return;
            }
        });

        // ä¿å­˜å†å²çŠ¶æ€
        function saveHistory() {
            const state = {
                savedObjects: JSON.parse(JSON.stringify(savedObjects)),
                currentObjectPoints: JSON.parse(JSON.stringify(currentObjectPoints)),
                currentObjectIndex: currentObjectIndex,
                currentObjectName: currentObjectName,
                currentObjectType: currentObjectType  // ä¿å­˜å¯¹è±¡ç±»å‹
            };
            
            // åˆ é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²è®°å½•
            history = history.slice(0, historyIndex + 1);
            history.push(state);
            historyIndex = history.length - 1;
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        // æ’¤é”€
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                restoreState(state);
                showStatus('å·²æ’¤é”€', 'success');
            } else {
                showStatus('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'error');
            }
        }

        // é‡åš
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                const state = history[historyIndex];
                restoreState(state);
                showStatus('å·²é‡åš', 'success');
            } else {
                showStatus('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ', 'error');
            }
        }

        // æ¢å¤çŠ¶æ€
        function restoreState(state) {
            savedObjects = JSON.parse(JSON.stringify(state.savedObjects));
            currentObjectPoints = JSON.parse(JSON.stringify(state.currentObjectPoints));
            currentObjectIndex = state.currentObjectIndex;
            currentObjectName = state.currentObjectName;
            currentObjectType = state.currentObjectType || 'object'; // æ¢å¤å¯¹è±¡ç±»å‹
            
            // é‡æ–°æ¸²æŸ“
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            renderSavedObjects();
            currentObjectPoints.forEach((point, idx) => {
                createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
            });
            
            updateObjectsList();
            updateStats();
        }

        // é€‰æ‹©æ–‡ä»¶å¤¹
        function selectFolder() {
            const folderSelector = document.getElementById('folder-selector');
            folderSelector.click();
        }

        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
        document.getElementById('folder-selector').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                // ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ä¸­æå–æ–‡ä»¶å¤¹è·¯å¾„
                const firstFile = files[0];
                let folderPathValue = '';
                
                if (firstFile.webkitRelativePath) {
                    // æå–æ–‡ä»¶å¤¹åç§°ï¼ˆç›¸å¯¹è·¯å¾„çš„ç¬¬ä¸€éƒ¨åˆ†ï¼‰
                    const relativePath = firstFile.webkitRelativePath;
                    const folderName = relativePath.split('/')[0];
                    
                    // æ˜¾ç¤ºæç¤ºï¼Œè®©ç”¨æˆ·è¾“å…¥å®Œæ•´è·¯å¾„
                    // å¦‚æœç”¨æˆ·çŸ¥é“è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥ï¼›å¦åˆ™å¯ä»¥è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼ŒæœåŠ¡å™¨ä¼šå°è¯•æŸ¥æ‰¾
                    folderPathValue = prompt(
                        'å·²é€‰æ‹©æ–‡ä»¶å¤¹: ' + folderName + '\n\nè¯·è¾“å…¥æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„ï¼ˆä¾‹å¦‚: /Users/username/Documents/folderï¼‰ï¼š\n\næç¤ºï¼šå¦‚æœè·¯å¾„ä¸­åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œè¯·ç¡®ä¿æ­£ç¡®è¾“å…¥ã€‚',
                        folderName
                    );
                } else {
                    // å¦‚æœæ²¡æœ‰webkitRelativePathï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                    folderPathValue = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„ï¼š');
                }
                
                if (folderPathValue && folderPathValue.trim()) {
                    folderPathValue = folderPathValue.trim();
                    document.getElementById('folder-path').value = folderPathValue;
                    folderPath = folderPathValue;
                    showStatus('å·²é€‰æ‹©æ–‡ä»¶å¤¹: ' + folderPathValue, 'success');
                }
                
                // æ¸…ç©ºé€‰æ‹©ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥é‡æ–°é€‰æ‹©
                e.target.value = '';
            }
        });

        // è¿‡æ»¤è§†é¢‘
        function filterVideos() {
            const searchTerm = document.getElementById('video-search').value.toLowerCase();
            filteredVideos = videos.filter(video => 
                video.name.toLowerCase().includes(searchTerm)
            );
            displayVideoList();
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨
        async function loadVideos() {
            folderPath = document.getElementById('folder-path').value.trim();
            if (!folderPath) {
                showStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'error');
                return;
            }

            // ä¿å­˜å½“å‰çš„ä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯åˆ°å…¨å±€å˜é‡
            globalTaskTemplate = document.getElementById('task-template').value.trim();
            globalScene = document.getElementById('scene').value.trim();

            showLoading(true);
            try {
                const response = await fetch('/api/simple_annotation/scan_videos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ folder_path: folderPath })
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥');
                }

                const data = await response.json();
                videos = data.videos || [];
                filteredVideos = [...videos];
                
                // åŠ è½½å·²æœ‰çš„æ ‡æ³¨æ•°æ®
                await loadAnnotations();

                displayVideoList();
                updateProgress();
                showLoading(false);
                showStatus(`æˆåŠŸåŠ è½½ ${videos.length} ä¸ªè§†é¢‘`, 'success');
                
                // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæœªæ ‡æ³¨çš„è§†é¢‘ï¼ˆè·³è¿‡æ— æ•ˆè§†é¢‘ï¼‰
                if (videos.length > 0) {
                    // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªæ ‡æ³¨ä¸”éæ— æ•ˆçš„è§†é¢‘
                    for (let i = 0; i < videos.length; i++) {
                        const video = videos[i];
                        const annotationKey = `${folderPath}|${video.name}`;
                        const annotation = annotations[annotationKey];
                        const isInvalid = annotation && annotation.is_invalid === true;
                        const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                        const isAnnotated = objectSpaceList.length > 0;
                        
                        // è·³è¿‡æ— æ•ˆè§†é¢‘å’Œå·²æ ‡æ³¨çš„è§†é¢‘
                        if (!isInvalid && !isAnnotated) {
                            // å»¶è¿Ÿä¸€ä¸‹å†é€‰æ‹©ï¼Œç¡®ä¿UIå·²æ›´æ–°
                            setTimeout(() => {
                                selectVideo(i);
                            }, 300);
                            break;
                        }
                    }
                }
            } catch (error) {
                showLoading(false);
                showStatus('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ ‡æ³¨æ•°æ®
        async function loadAnnotations() {
            try {
                const response = await fetch('/api/simple_annotation/load_annotations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ folder_path: folderPath })
                });

                if (response.ok) {
                    const data = await response.json();
                    annotations = data.annotations || {};
                }
            } catch (error) {
                console.error('åŠ è½½æ ‡æ³¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            if (videos.length === 0) {
                document.getElementById('progress-fill').style.width = '0%';
                return;
            }
            
            let annotatedCount = 0;
            videos.forEach(video => {
                const annotationKey = `${folderPath}|${video.name}`;
                const annotation = annotations[annotationKey];
                const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                const isAnnotated = objectSpaceList.length > 0;
                if (isAnnotated) annotatedCount++;
            });
            
            const progress = (annotatedCount / videos.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (currentVideo) {
                document.getElementById('stat-current-video').textContent = currentVideo.name;
            } else {
                document.getElementById('stat-current-video').textContent = '-';
            }
            
            const totalObjects = savedObjects.length;
            const totalPoints = savedObjects.reduce((sum, obj) => sum + (obj.points ? obj.points.length : 0), 0) +
                               currentObjectPoints.length;
            
            document.getElementById('stat-objects-count').textContent = totalObjects;
            document.getElementById('stat-points-count').textContent = totalPoints;
            
            // æ›´æ–°è§†é¢‘ç»Ÿè®¡
            if (videos.length > 0) {
                let annotatedCount = 0;
                videos.forEach(video => {
                    const annotationKey = `${folderPath}|${video.name}`;
                    const annotation = annotations[annotationKey];
                    const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                    const isAnnotated = objectSpaceList.length > 0;
                    if (isAnnotated) annotatedCount++;
                });
                
                const progressPercent = Math.round((annotatedCount / videos.length) * 100);
                document.getElementById('stat-progress').textContent = `${progressPercent}%`;
                
                document.getElementById('video-stats').innerHTML = `
                    <div>æ€»è®¡: ${videos.length} ä¸ªè§†é¢‘</div>
                    <div>å·²æ ‡æ³¨: ${annotatedCount} ä¸ª</div>
                    <div>æœªæ ‡æ³¨: ${videos.length - annotatedCount} ä¸ª</div>
                `;
                
                document.getElementById('video-count').textContent = `(${filteredVideos.length}/${videos.length})`;
            }
        }

        // æ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
        function displayVideoList() {
            const container = document.getElementById('video-list');
            container.innerHTML = '';

            filteredVideos.forEach((video, index) => {
                // æ‰¾åˆ°åŸå§‹ç´¢å¼•
                const originalIndex = videos.findIndex(v => v.name === video.name);
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                if (originalIndex === currentVideoIndex) {
                    videoItem.classList.add('active');
                }
                
                const annotationKey = `${folderPath}|${video.name}`;
                const annotation = annotations[annotationKey];
                const isInvalid = annotation && annotation.is_invalid === true;
                const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                const isAnnotated = objectSpaceList.length > 0;
                
                if (isInvalid) {
                    videoItem.classList.add('invalid');
                    videoItem.style.borderLeft = '4px solid #ff6b6b';
                } else if (isAnnotated) {
                    videoItem.classList.add('annotated');
                } else {
                    videoItem.classList.add('unannotated');
                }

                let statusText = '';
                if (isInvalid) {
                    statusText = 'âŒ æ— æ•ˆè§†é¢‘';
                } else if (isAnnotated) {
                    statusText = 'âœ“ å·²æ ‡æ³¨';
                } else {
                    statusText = 'â—‹ æœªæ ‡æ³¨';
                }

                videoItem.innerHTML = `
                    <div class="video-item-name">${video.name}</div>
                    <div class="video-item-status">${statusText}</div>
                `;

                videoItem.addEventListener('click', () => {
                    selectVideo(originalIndex);
                });

                container.appendChild(videoItem);
            });

            document.getElementById('main-content').style.display = 'grid';
            updateStats();
        }

        // é€‰æ‹©è§†é¢‘
        async function selectVideo(index) {
            if (index < 0 || index >= videos.length) return;

            currentVideoIndex = index;
            currentVideo = videos[index];
            currentObjectIndex = -1;
            currentObjectPoints = [];
            currentObjectName = '';
            currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
            savedObjects = []; // é‡ç½®å·²ä¿å­˜å¯¹è±¡åˆ—è¡¨
            selectedPointIndex = -1;
            editingObjectIndex = -1;
            editingObjectPoints = [];
            history = [];
            historyIndex = -1;
            currentASRResult = null; // é‡ç½®ASRç»“æœ
            
            // éšè—ç¼–è¾‘æŒ‰é’®
            document.getElementById('save-editing-btn').style.display = 'none';
            document.getElementById('cancel-editing-btn').style.display = 'none';

            console.log(`[æ ‡æ³¨äº¤äº’] é€‰æ‹©è§†é¢‘`, {
                video_index: index,
                video_name: currentVideo.name,
                video_path: currentVideo.path,
                timestamp: new Date().toISOString()
            });

            displayVideoList();

            showLoading(true);
            try {
                // åŠ è½½è§†é¢‘å’Œæœ€åä¸€å¸§
                const response = await fetch('/api/simple_annotation/get_video_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        video_name: currentVideo.name
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    // å°è¯•è·å–åç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    const errorMsg = data.error || 'åŠ è½½è§†é¢‘ä¿¡æ¯å¤±è´¥';
                    console.error('[æ ‡æ³¨äº¤äº’] åŠ è½½è§†é¢‘ä¿¡æ¯å¤±è´¥:', errorMsg, data);
                    throw new Error(errorMsg);
                }
                
                // è®¾ç½®è§†é¢‘æ’­æ”¾å™¨
                const videoPlayer = document.getElementById('video-player');
                videoPlayer.src = data.video_url;
                // è®¾ç½®é»˜è®¤æ’­æ”¾é€Ÿåº¦ä¸º1.5å€é€Ÿ
                videoPlayer.playbackRate = 1.5;
                
                // è®¾ç½®æœ€åä¸€å¸§å›¾åƒ
                const lastFrameImage = document.getElementById('last-frame-image');
                lastFrameImage.src = data.last_frame_url;
                lastFrameImage.onload = () => {
                    // é‡æ–°è®¾ç½®ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆæ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨ï¼‰
                    const imageContainer = document.getElementById('image-container');
                    // ç§»é™¤æ‰€æœ‰æ—§çš„æ ‡è®°ç‚¹
                    const oldMarkers = imageContainer.querySelectorAll('.point-marker');
                    oldMarkers.forEach(marker => marker.remove());
                    
                    // å…ˆæ¸…ç©ºæ‰€æœ‰çŠ¶æ€ï¼Œå†åŠ è½½æ ‡æ³¨
                    currentObjectIndex = -1;
                    currentObjectPoints = [];
                    currentObjectName = '';
                    currentObjectType = 'object';
                    savedObjects = [];
                    editingObjectIndex = -1;
                    editingObjectPoints = [];
                    selectedPointIndex = -1;
                    
                    setupImageClickHandler();
                    loadVideoAnnotations();
                    
                    // å›¾åƒå°ºå¯¸å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“æ ‡è®°ç‚¹
                    const resizeHandler = function() {
                        const markers = imageContainer.querySelectorAll('.point-marker');
                        markers.forEach(marker => marker.remove());
                        
                        // å¦‚æœæ­£åœ¨ç¼–è¾‘å¯¹è±¡ï¼Œéœ€è¦é‡æ–°è®¡ç®—ç¼–è¾‘ç‚¹çš„ä½ç½®
                        if (editingObjectIndex >= 0) {
                            const imageRect = document.getElementById('last-frame-image').getBoundingClientRect();
                            const containerRect = imageContainer.getBoundingClientRect();
                            const imageOffsetX = (containerRect.width - imageRect.width) / 2;
                            const imageOffsetY = (containerRect.height - imageRect.height) / 2;
                            
                            // æ›´æ–°ç¼–è¾‘ç‚¹çš„æ˜¾ç¤ºä½ç½®
                            editingObjectPoints.forEach(point => {
                                point.displayX = point.x * imageRect.width + imageOffsetX;
                                point.displayY = point.y * imageRect.height + imageOffsetY;
                            });
                            
                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰å¯¹è±¡
                            savedObjects.forEach((savedObj, objIdx) => {
                                if (objIdx !== editingObjectIndex) {
                                    savedObj.points.forEach((point, pointIdx) => {
                                        const normalizedX = point[1] / 1000;
                                        const normalizedY = point[0] / 1000;
                                        const displayX = normalizedX * imageRect.width + imageOffsetX;
                                        const displayY = normalizedY * imageRect.height + imageOffsetY;
                                        
                                        createPointMarker(
                                            { displayX, displayY },
                                            objIdx,
                                            true,
                                            savedObj.name,
                                            pointIdx,
                                            false
                                        );
                                    });
                                }
                            });
                            
                            // æ¸²æŸ“ç¼–è¾‘å¯¹è±¡çš„ç‚¹
                            const obj = savedObjects[editingObjectIndex];
                            editingObjectPoints.forEach((point, idx) => {
                                createPointMarker(point, editingObjectIndex, false, obj.name, idx, true);
                            });
                        } else {
                            renderSavedObjects();
                        }
                        
                        // é‡æ–°æ¸²æŸ“å½“å‰ç¼–è¾‘çš„ç‚¹
                        currentObjectPoints.forEach((point, idx) => {
                            createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
                        });
                    };
                    
                    // ç§»é™¤æ—§çš„resizeç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    window.removeEventListener('resize', resizeHandler);
                    window.addEventListener('resize', resizeHandler);
                };

                showLoading(false);
                updateStats();
                
                // è‡ªåŠ¨è¿›è¡ŒASRè¯†åˆ«
                performASRRecognition();
            } catch (error) {
                showLoading(false);
                showStatus('åŠ è½½è§†é¢‘å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡ŒASRè¯†åˆ«
        async function performASRRecognition() {
            if (!currentVideo || !folderPath) {
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('asr-loading').style.display = 'flex';
            document.getElementById('asr-text-content').style.display = 'none';
            document.getElementById('asr-error').style.display = 'none';

            try {
                const response = await fetch('/api/simple_annotation/asr_recognition', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        video_name: currentVideo.name
                    })
                });

                const data = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('asr-loading').style.display = 'none';

                if (data.success && data.text && data.text.trim()) {
                    // ä¿å­˜å®Œæ•´çš„ASRç»“æœï¼ˆåŒ…æ‹¬å¤šä¸ªå¥å­å’Œè¯æ±‡çº§åˆ«ï¼‰
                    currentASRResult = {
                        sentences: data.sentences || (data.sentence ? [data.sentence] : []),
                        text: data.text, // å®Œæ•´æ–‡æœ¬ï¼ˆæ‰€æœ‰å¥å­åˆå¹¶ï¼‰
                        words: data.words || []
                    };
                    
                    // æ˜¾ç¤ºè¯†åˆ«ç»“æœï¼ˆæ”¯æŒå¤šä¸ªå¥å­ï¼‰
                    displayASRResult(currentASRResult);
                } else {
                    // ASRè¯†åˆ«å¤±è´¥æˆ–ä¸ºç©ºï¼Œæ˜¾ç¤ºå‹å¥½æç¤ºè€Œä¸æ˜¯é”™è¯¯
                    const errorMsg = data.error || 'æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹';
                    document.getElementById('asr-error').textContent = 'âš ï¸ ' + errorMsg;
                    document.getElementById('asr-error').style.display = 'block';
                    document.getElementById('asr-text-content').style.display = 'none';
                    currentASRResult = null;
                }
            } catch (error) {
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('asr-loading').style.display = 'none';
                // ASRè¯†åˆ«å¤±è´¥ï¼Œæ˜¾ç¤ºå‹å¥½æç¤ºè€Œä¸æ˜¯é”™è¯¯
                document.getElementById('asr-error').textContent = 'âš ï¸ ASRè¯†åˆ«å¤±è´¥: ' + error.message;
                document.getElementById('asr-error').style.display = 'block';
                document.getElementById('asr-text-content').style.display = 'none';
                currentASRResult = null;
            }
        }

        // è®¾ç½®å›¾åƒç‚¹å‡»å¤„ç†
        function setupImageClickHandler() {
            const imageContainer = document.getElementById('image-container');
            const lastFrameImage = document.getElementById('last-frame-image');
            
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const newHandler = (e) => {
                // å¦‚æœæ­£åœ¨ç¼–è¾‘å·²ä¿å­˜çš„å¯¹è±¡ï¼Œä¸å…è®¸æ·»åŠ æ–°ç‚¹
                if (editingObjectIndex >= 0) {
                    showStatus('æ­£åœ¨ç¼–è¾‘å¯¹è±¡ï¼Œè¯·å…ˆä¿å­˜æˆ–å–æ¶ˆç¼–è¾‘', 'error');
                    return;
                }
                
                if (currentObjectIndex === -1) {
                    showStatus('è¯·å…ˆç‚¹å‡»"æ·»åŠ ç›®æ ‡å¯¹è±¡"æŒ‰é’®', 'error');
                    return;
                }

                const rect = imageContainer.getBoundingClientRect();
                const imageRect = lastFrameImage.getBoundingClientRect();
                
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // è®¡ç®—ç›¸å¯¹äºå›¾åƒçš„åæ ‡
                const imageOffsetX = (rect.width - imageRect.width) / 2;
                const imageOffsetY = (rect.height - imageRect.height) / 2;
                
                const relativeX = clickX - imageOffsetX;
                const relativeY = clickY - imageOffsetY;
                
                // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨å›¾åƒèŒƒå›´å†…
                if (relativeX < 0 || relativeX > imageRect.width || 
                    relativeY < 0 || relativeY > imageRect.height) {
                    return;
                }

                // è½¬æ¢ä¸ºå½’ä¸€åŒ–åæ ‡ (0-1)
                const normalizedX = relativeX / imageRect.width;
                const normalizedY = relativeY / imageRect.height;

                // æ·»åŠ ç‚¹
                addPoint(normalizedX, normalizedY, clickX, clickY);
            };
            
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨å¹¶æ·»åŠ æ–°çš„
            imageContainer.removeEventListener('click', imageContainer._clickHandler);
            imageContainer._clickHandler = newHandler;
            imageContainer.addEventListener('click', newHandler);
        }

        // æ·»åŠ ç‚¹
        function addPoint(normalizedX, normalizedY, displayX, displayY) {
            const point = {
                x: normalizedX,
                y: normalizedY,
                displayX: displayX,
                displayY: displayY
            };

            saveHistory();
            currentObjectPoints.push(point);
            createPointMarker(point, currentObjectIndex, false, currentObjectName, currentObjectPoints.length - 1);
            updateObjectsList();
            updateStats();
            
            // æ‰“å°æ ‡æ³¨äº¤äº’ä¿¡æ¯
            console.log(`[æ ‡æ³¨äº¤äº’] æ·»åŠ æ ‡æ³¨ç‚¹`, {
                video: currentVideo.name,
                object_index: currentObjectIndex,
                object_name: currentObjectName,
                point_index: currentObjectPoints.length - 1,
                normalized_coords: {x: normalizedX, y: normalizedY},
                pixel_coords: {x: Math.round(normalizedX * 1000), y: Math.round(normalizedY * 1000)},
                total_points: currentObjectPoints.length,
                timestamp: new Date().toISOString()
            });
        }

        // åˆ›å»ºç‚¹æ ‡è®°
        function createPointMarker(point, objectIndex, isSaved = false, objectName = null, pointIndex = -1, isEditingMode = false) {
            const imageContainer = document.getElementById('image-container');
            const marker = document.createElement('div');
            marker.className = `point-marker object-${objectIndex % 5}`;
            if (isSaved && !isEditingMode) {
                marker.classList.add('saved-marker'); // æ·»åŠ å·²ä¿å­˜æ ‡è®°çš„æ ·å¼ç±»
            } else {
                marker.classList.add('editing-marker'); // æ·»åŠ æ­£åœ¨ç¼–è¾‘æ ‡è®°çš„æ ·å¼ç±»
            }
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ editingç±»
            if (isEditingMode) {
                marker.classList.add('editing');
            }
            
            marker.style.left = point.displayX + 'px';
            marker.style.top = point.displayY + 'px';
            marker.dataset.pointIndex = pointIndex;
            marker.dataset.objectIndex = objectIndex;
            marker.dataset.isSaved = isSaved;
            marker.dataset.isEditing = isEditingMode;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶é€‰æ‹©ç‚¹
            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥é€‰æ‹©ç‚¹ï¼ˆç”¨äºåˆ é™¤ï¼‰
                selectPoint(marker, pointIndex, objectIndex, isSaved || isEditingMode);
            });
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ æ‹–åŠ¨åŠŸèƒ½
            if (isEditingMode) {
                marker.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    startDrag(marker, e, pointIndex);
                });
            }
            
            const label = document.createElement('div');
            label.className = 'point-label';
            label.textContent = objectName || currentObjectName || `å¯¹è±¡${objectIndex + 1}`;
            marker.appendChild(label);

            imageContainer.appendChild(marker);
        }

        // å¼€å§‹æ‹–åŠ¨
        function startDrag(marker, e, pointIndex) {
            draggedMarker = marker;
            selectedPointIndex = pointIndex;
            
            const rect = marker.getBoundingClientRect();
            const imageContainer = document.getElementById('image-container');
            const containerRect = imageContainer.getBoundingClientRect();
            
            dragOffset.x = e.clientX - containerRect.left - parseFloat(marker.style.left);
            dragOffset.y = e.clientY - containerRect.top - parseFloat(marker.style.top);
            
            marker.classList.add('dragging');
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
            
            e.preventDefault();
        }

        // æ‹–åŠ¨ä¸­
        function onDrag(e) {
            if (!draggedMarker) return;
            
            const imageContainer = document.getElementById('image-container');
            const containerRect = imageContainer.getBoundingClientRect();
            const lastFrameImage = document.getElementById('last-frame-image');
            const imageRect = lastFrameImage.getBoundingClientRect();
            
            const imageOffsetX = (containerRect.width - imageRect.width) / 2;
            const imageOffsetY = (containerRect.height - imageRect.height) / 2;
            
            let newX = e.clientX - containerRect.left - dragOffset.x;
            let newY = e.clientY - containerRect.top - dragOffset.y;
            
            // é™åˆ¶åœ¨å›¾åƒèŒƒå›´å†…
            newX = Math.max(imageOffsetX, Math.min(newX, imageOffsetX + imageRect.width));
            newY = Math.max(imageOffsetY, Math.min(newY, imageOffsetY + imageRect.height));
            
            draggedMarker.style.left = newX + 'px';
            draggedMarker.style.top = newY + 'px';
            
            // æ›´æ–°å¯¹åº”çš„ç‚¹æ•°æ®
            const pointIndex = parseInt(draggedMarker.dataset.pointIndex);
            const objectIndex = parseInt(draggedMarker.dataset.objectIndex);
            
            if (editingObjectIndex >= 0 && editingObjectPoints[pointIndex]) {
                // è®¡ç®—å½’ä¸€åŒ–åæ ‡
                const relativeX = newX - imageOffsetX;
                const relativeY = newY - imageOffsetY;
                const normalizedX = relativeX / imageRect.width;
                const normalizedY = relativeY / imageRect.height;
                
                editingObjectPoints[pointIndex].x = normalizedX;
                editingObjectPoints[pointIndex].y = normalizedY;
                editingObjectPoints[pointIndex].displayX = newX;
                editingObjectPoints[pointIndex].displayY = newY;
            }
        }

        // åœæ­¢æ‹–åŠ¨
        function stopDrag() {
            if (draggedMarker) {
                draggedMarker.classList.remove('dragging');
                draggedMarker = null;
            }
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // é€‰æ‹©ç‚¹
        function selectPoint(marker, pointIndex, objectIndex, isSaved) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.point-marker.selected').forEach(m => {
                m.classList.remove('selected');
            });
            
            // é€‰ä¸­å½“å‰ç‚¹
            marker.classList.add('selected');
            selectedPointIndex = pointIndex;
            
            // å¦‚æœæ˜¯å·²ä¿å­˜çš„ç‚¹ï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„å¯¹è±¡å’Œç‚¹
            if (isSaved) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¼–è¾‘å·²ä¿å­˜ç‚¹çš„åŠŸèƒ½
            }
        }

        // åˆ é™¤é€‰ä¸­çš„ç‚¹
        function deleteSelectedPoint() {
            // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œåˆ é™¤ç¼–è¾‘å¯¹è±¡çš„ç‚¹
            if (editingObjectIndex >= 0 && selectedPointIndex >= 0) {
                saveHistory();
                
                // ç§»é™¤æ ‡è®°
                const markers = document.querySelectorAll('.point-marker.selected');
                markers.forEach(marker => marker.remove());
                
                // ä»ç¼–è¾‘ç‚¹æ•°ç»„ä¸­åˆ é™¤
                editingObjectPoints.splice(selectedPointIndex, 1);
                selectedPointIndex = -1;
                
                // é‡æ–°æ¸²æŸ“ç¼–è¾‘å¯¹è±¡çš„ç‚¹
                const imageContainer = document.getElementById('image-container');
                const editingMarkers = imageContainer.querySelectorAll('.point-marker.editing');
                editingMarkers.forEach(marker => marker.remove());
                
                const obj = savedObjects[editingObjectIndex];
                editingObjectPoints.forEach((point, idx) => {
                    createPointMarker(point, editingObjectIndex, false, obj.name, idx, true);
                });
                
                updateObjectsList();
                updateStats();
                showStatus('å·²åˆ é™¤é€‰ä¸­ç‚¹', 'success');
                return;
            }
            
            // å¦åˆ™åˆ é™¤å½“å‰ç¼–è¾‘å¯¹è±¡çš„ç‚¹
            if (selectedPointIndex < 0 || currentObjectIndex < 0) {
                return;
            }
            
            saveHistory();
            
            // ç§»é™¤æ ‡è®°
            const markers = document.querySelectorAll('.point-marker.selected');
            markers.forEach(marker => marker.remove());
            
            // ä»æ•°ç»„ä¸­åˆ é™¤ç‚¹
            currentObjectPoints.splice(selectedPointIndex, 1);
            selectedPointIndex = -1;
            
            // é‡æ–°æ¸²æŸ“å½“å‰å¯¹è±¡çš„ç‚¹
            const imageContainer = document.getElementById('image-container');
            const editingMarkers = imageContainer.querySelectorAll('.editing-marker');
            editingMarkers.forEach(marker => marker.remove());
            
            currentObjectPoints.forEach((point, idx) => {
                createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
            });
            
            updateObjectsList();
            updateStats();
            showStatus('å·²åˆ é™¤é€‰ä¸­ç‚¹', 'success');
        }

        // æ·»åŠ ç›®æ ‡å¯¹è±¡
        function addObject() {
            if (!currentVideo) {
                showStatus('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
                return;
            }

            // å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥ç±»åˆ«
            const category = prompt('è¯·è¾“å…¥å¯¹è±¡ç±»åˆ«ï¼ˆä¾‹å¦‚ï¼šæ¯å­ã€ä¹¦æœ¬ã€é¼ æ ‡ç­‰ï¼‰ï¼š');
            if (category === null || category.trim() === '') {
                return; // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©º
            }
            
            // è®¡ç®—æ–°çš„å¯¹è±¡ç´¢å¼•ï¼ˆåŒ…æ‹¬å·²ä¿å­˜çš„å¯¹è±¡ï¼‰
            currentObjectIndex = savedObjects.length;
            currentObjectPoints = [];
            currentObjectName = category.trim();
            currentObjectType = 'object'; // è®¾ç½®ä¸ºå¯¹è±¡ç±»å‹
            selectedPointIndex = -1;
            
            saveHistory();
            
            console.log(`[æ ‡æ³¨äº¤äº’] æ·»åŠ æ–°å¯¹è±¡`, {
                video: currentVideo.name,
                object_index: currentObjectIndex,
                category: currentObjectName,
                type: currentObjectType,
                saved_objects_count: savedObjects.length,
                timestamp: new Date().toISOString()
            });
            
            showStatus(`å·²æ·»åŠ ç›®æ ‡å¯¹è±¡: ${currentObjectName}ï¼Œè¯·åœ¨å›¾åƒä¸Šç‚¹å‡»æ ‡æ³¨ç‚¹`, 'success');
            updateObjectsList();
        }

        // æ·»åŠ æ”¾ç½®ç©ºé—´
        function addPlacementSpace() {
            if (!currentVideo) {
                showStatus('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
                return;
            }

            // å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥æ”¾ç½®ç©ºé—´ç±»åˆ«
            const category = prompt('è¯·è¾“å…¥æ”¾ç½®ç©ºé—´ç±»åˆ«ï¼ˆä¾‹å¦‚ï¼šé»‘è‰²ç¬”çš„å³è¾¹ç­‰ï¼‰ï¼š');
            if (category === null || category.trim() === '') {
                return; // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©º
            }
            
            // è®¡ç®—æ–°çš„å¯¹è±¡ç´¢å¼•ï¼ˆåŒ…æ‹¬å·²ä¿å­˜çš„å¯¹è±¡ï¼‰
            currentObjectIndex = savedObjects.length;
            currentObjectPoints = [];
            currentObjectName = category.trim();
            currentObjectType = 'space'; // è®¾ç½®ä¸ºæ”¾ç½®ç©ºé—´ç±»å‹
            selectedPointIndex = -1;
            
            saveHistory();
            
            console.log(`[æ ‡æ³¨äº¤äº’] æ·»åŠ æ”¾ç½®ç©ºé—´`, {
                video: currentVideo.name,
                object_index: currentObjectIndex,
                category: currentObjectName,
                type: currentObjectType,
                saved_objects_count: savedObjects.length,
                timestamp: new Date().toISOString()
            });
            
            showStatus(`å·²æ·»åŠ æ”¾ç½®ç©ºé—´: ${currentObjectName}ï¼Œè¯·åœ¨å›¾åƒä¸Šç‚¹å‡»æ ‡æ³¨ç‚¹`, 'success');
            updateObjectsList();
        }

        // ä¿å­˜å½“å‰ç›®æ ‡å¯¹è±¡
        function saveCurrentObject() {
            if (!currentVideo) {
                showStatus('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
                return;
            }

            if (currentObjectIndex === -1 || currentObjectPoints.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ ç›®æ ‡å¯¹è±¡å¹¶æ ‡æ³¨ç‚¹', 'error');
                return;
            }

            // æ„å»ºå½“å‰å¯¹è±¡æ•°æ®
            const points = currentObjectPoints.map(p => [
                Math.round(p.y * 1000),  // yåæ ‡ (0-1000)
                Math.round(p.x * 1000)   // xåæ ‡ (0-1000)
            ]);

            const objectData = {
                name: currentObjectName,
                points: points,
                type: currentObjectType  // æ·»åŠ ç±»å‹å­—æ®µï¼š'object' æˆ– 'space'
            };

            saveHistory();
            
            // æ·»åŠ åˆ°å·²ä¿å­˜å¯¹è±¡åˆ—è¡¨
            savedObjects.push(objectData);

            console.log(`[æ ‡æ³¨äº¤äº’] ä¿å­˜ç›®æ ‡å¯¹è±¡`, {
                video: currentVideo.name,
                object_index: currentObjectIndex,
                object_name: currentObjectName,
                points_count: points.length,
                total_saved_objects: savedObjects.length,
                timestamp: new Date().toISOString()
            });

            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ ‡è®°ç‚¹ï¼ˆåŒ…æ‹¬åˆšä¿å­˜çš„ï¼‰
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            renderSavedObjects();
            
            // é‡ç½®å½“å‰ç¼–è¾‘å¯¹è±¡
            currentObjectIndex = -1;
            currentObjectPoints = [];
            currentObjectName = '';
            currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
            selectedPointIndex = -1;
            
            updateObjectsList();
            updateStats();
            showStatus(`ç›®æ ‡å¯¹è±¡ "${objectData.name}" å·²ä¿å­˜ï¼å¯ä»¥ç»§ç»­æ·»åŠ æ–°ç›®æ ‡`, 'success');
            
            // è‡ªåŠ¨ä¿å­˜
            scheduleAutoSave();
        }

        // æ¸…é™¤å½“å‰å¯¹è±¡
        function clearCurrentObject() {
            if (currentObjectIndex === -1) {
                showStatus('æ²¡æœ‰å½“å‰å¯¹è±¡', 'error');
                return;
            }

            console.log(`[æ ‡æ³¨äº¤äº’] æ¸…é™¤å½“å‰å¯¹è±¡`, {
                video: currentVideo.name,
                object_index: currentObjectIndex,
                object_name: currentObjectName,
                cleared_points: currentObjectPoints.length,
                timestamp: new Date().toISOString()
            });

            // ç§»é™¤å½“å‰å¯¹è±¡çš„æ ‡è®°ç‚¹ï¼ˆåªç§»é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç‚¹ï¼‰
            const imageContainer = document.getElementById('image-container');
            // æ‰¾åˆ°æ‰€æœ‰æ­£åœ¨ç¼–è¾‘çš„æ ‡è®°ç‚¹ï¼ˆediting-markerç±»ï¼‰ï¼Œç§»é™¤å®ƒä»¬
            const editingMarkers = imageContainer.querySelectorAll('.editing-marker');
            editingMarkers.forEach(marker => {
                // æ£€æŸ¥è¿™ä¸ªæ ‡è®°ç‚¹æ˜¯å¦å±äºå½“å‰ç¼–è¾‘çš„å¯¹è±¡ï¼ˆé€šè¿‡æ£€æŸ¥ä½ç½®ï¼‰
                const markerX = parseFloat(marker.style.left);
                const markerY = parseFloat(marker.style.top);
                
                // æ£€æŸ¥æ˜¯å¦ä¸å½“å‰å¯¹è±¡çš„ç‚¹åŒ¹é…
                const isCurrentObjectPoint = currentObjectPoints.some(p => {
                    const expectedX = p.displayX;
                    const expectedY = p.displayY;
                    return Math.abs(markerX - expectedX) < 5 && Math.abs(markerY - expectedY) < 5;
                });
                
                if (isCurrentObjectPoint) {
                    marker.remove();
                }
            });

            saveHistory();
            currentObjectPoints = [];
            currentObjectName = '';
            currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
            selectedPointIndex = -1;
            updateObjectsList();
            updateStats();
            showStatus('å·²æ¸…é™¤å½“å‰å¯¹è±¡', 'success');
        }

        // åˆ é™¤å¯¹è±¡
        function deleteObject(index) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è±¡ "${savedObjects[index].name}" å—ï¼Ÿ`)) {
                return;
            }
            
            // å¦‚æœæ­£åœ¨ç¼–è¾‘è¯¥å¯¹è±¡ï¼Œå…ˆå–æ¶ˆç¼–è¾‘
            if (editingObjectIndex === index) {
                cancelEditingObject();
            }
            
            saveHistory();
            savedObjects.splice(index, 1);
            
            // é‡æ–°æ¸²æŸ“
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            renderSavedObjects();
            if (currentObjectIndex >= 0 && currentObjectPoints.length > 0) {
                currentObjectPoints.forEach((point, idx) => {
                    createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
                });
            }
            
            updateObjectsList();
            updateStats();
            showStatus('å·²åˆ é™¤å¯¹è±¡', 'success');
            
            // è‡ªåŠ¨ä¿å­˜
            scheduleAutoSave();
        }

        // ç¼–è¾‘å¯¹è±¡ï¼ˆæ¿€æ´»ç‚¹çš„ç¼–è¾‘æ¨¡å¼ï¼‰
        function editObject(index) {
            if (editingObjectIndex >= 0 && editingObjectIndex !== index) {
                if (!confirm('æ­£åœ¨ç¼–è¾‘å…¶ä»–å¯¹è±¡ï¼Œæ˜¯å¦ä¿å­˜å½“å‰ç¼–è¾‘ï¼Ÿ')) {
                    saveEditingObject();
                } else {
                    cancelEditingObject();
                }
            }
            
            editingObjectIndex = index;
            const obj = savedObjects[index];
            
            // å°†å¯¹è±¡ç‚¹è½¬æ¢ä¸ºå¯ç¼–è¾‘æ ¼å¼
            const imageContainer = document.getElementById('image-container');
            const imageRect = document.getElementById('last-frame-image').getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            const imageOffsetX = (containerRect.width - imageRect.width) / 2;
            const imageOffsetY = (containerRect.height - imageRect.height) / 2;
            
            editingObjectPoints = obj.points.map(point => {
                const normalizedX = point[1] / 1000;
                const normalizedY = point[0] / 1000;
                const displayX = normalizedX * imageRect.width + imageOffsetX;
                const displayY = normalizedY * imageRect.height + imageOffsetY;
                
                return {
                    x: normalizedX,
                    y: normalizedY,
                    displayX: displayX,
                    displayY: displayY
                };
            });
            
            // æ¸…é™¤æ‰€æœ‰æ ‡è®°å¹¶é‡æ–°æ¸²æŸ“
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            // æ¸²æŸ“å…¶ä»–å·²ä¿å­˜çš„å¯¹è±¡ï¼ˆéç¼–è¾‘æ¨¡å¼ï¼‰
            savedObjects.forEach((savedObj, objIdx) => {
                if (objIdx !== index) {
                    savedObj.points.forEach((point, pointIdx) => {
                        const normalizedX = point[1] / 1000;
                        const normalizedY = point[0] / 1000;
                        const displayX = normalizedX * imageRect.width + imageOffsetX;
                        const displayY = normalizedY * imageRect.height + imageOffsetY;
                        
                        createPointMarker(
                            { displayX, displayY },
                            objIdx,
                            true,
                            savedObj.name,
                            pointIdx,
                            false
                        );
                    });
                }
            });
            
            // æ¸²æŸ“æ­£åœ¨ç¼–è¾‘çš„å¯¹è±¡ç‚¹ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            editingObjectPoints.forEach((point, idx) => {
                createPointMarker(point, index, false, obj.name, idx, true);
            });
            
            // æ¸²æŸ“å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–°å¯¹è±¡ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (currentObjectIndex >= 0 && currentObjectPoints.length > 0) {
                currentObjectPoints.forEach((point, idx) => {
                    createPointMarker(point, currentObjectIndex, false, currentObjectName, idx, false);
                });
            }
            
            // æ˜¾ç¤ºä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
            document.getElementById('save-editing-btn').style.display = 'inline-block';
            document.getElementById('cancel-editing-btn').style.display = 'inline-block';
            
            updateObjectsList();
            showStatus(`æ­£åœ¨ç¼–è¾‘å¯¹è±¡: ${obj.name}ï¼Œå¯ä»¥æ‹–åŠ¨ç‚¹è¿›è¡Œç¼–è¾‘ï¼Œç‚¹å‡»ç‚¹åæŒ‰Deleteåˆ é™¤`, 'success');
        }

        // ä¿å­˜ç¼–è¾‘çš„å¯¹è±¡
        function saveEditingObject() {
            if (editingObjectIndex < 0 || editingObjectPoints.length === 0) {
                return;
            }
            
            saveHistory();
            
            // æ›´æ–°å¯¹è±¡ç‚¹æ•°æ®
            const points = editingObjectPoints.map(p => [
                Math.round(p.y * 1000),  // yåæ ‡ (0-1000)
                Math.round(p.x * 1000)   // xåæ ‡ (0-1000)
            ]);
            
            savedObjects[editingObjectIndex].points = points;
            
            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            editingObjectIndex = -1;
            editingObjectPoints = [];
            
            // éšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
            document.getElementById('save-editing-btn').style.display = 'none';
            document.getElementById('cancel-editing-btn').style.display = 'none';
            
            // é‡æ–°æ¸²æŸ“
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            renderSavedObjects();
            if (currentObjectIndex >= 0 && currentObjectPoints.length > 0) {
                currentObjectPoints.forEach((point, idx) => {
                    createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
                });
            }
            
            updateObjectsList();
            updateStats();
            showStatus('å·²ä¿å­˜ç¼–è¾‘', 'success');
            
            // è‡ªåŠ¨ä¿å­˜
            scheduleAutoSave();
        }

        // å–æ¶ˆç¼–è¾‘å¯¹è±¡
        function cancelEditingObject() {
            if (editingObjectIndex < 0) {
                return;
            }
            
            editingObjectIndex = -1;
            editingObjectPoints = [];
            selectedPointIndex = -1;
            
            // éšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
            document.getElementById('save-editing-btn').style.display = 'none';
            document.getElementById('cancel-editing-btn').style.display = 'none';
            
            // é‡æ–°æ¸²æŸ“
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            renderSavedObjects();
            if (currentObjectIndex >= 0 && currentObjectPoints.length > 0) {
                currentObjectPoints.forEach((point, idx) => {
                    createPointMarker(point, currentObjectIndex, false, currentObjectName, idx);
                });
            }
            
            updateObjectsList();
            showStatus('å·²å–æ¶ˆç¼–è¾‘', 'success');
        }

        // è‡ªåŠ¨ä¿å­˜
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            autoSaveTimer = setTimeout(() => {
                if (currentVideo && savedObjects.length > 0) {
                    const taskTemplate = document.getElementById('task-template').value.trim();
                    const scene = document.getElementById('scene').value.trim();
                    
                    if (taskTemplate && scene) {
                        saveAnnotations(true); // é™é»˜ä¿å­˜
                    }
                }
            }, 5000); // 5ç§’åè‡ªåŠ¨ä¿å­˜
        }

        // æ›´æ–°å¯¹è±¡åˆ—è¡¨æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºæ‰€æœ‰å¯¹è±¡ï¼šå·²ä¿å­˜çš„ + æ­£åœ¨ç¼–è¾‘çš„ï¼‰
        function updateObjectsList() {
            const container = document.getElementById('objects-list');
            container.innerHTML = '';

            // æ˜¾ç¤ºå·²ä¿å­˜çš„å¯¹è±¡
            savedObjects.forEach((obj, index) => {
                const objectItem = document.createElement('div');
                objectItem.className = 'object-item saved-object';
                if (editingObjectIndex === index) {
                    objectItem.classList.add('active-editing');
                }
                const displayName = obj.name || `ç›®æ ‡å¯¹è±¡${index + 1}`;
                const objType = obj.type || 'object';
                const typeLabel = objType === 'space' ? '<span style="font-size: 0.7em; color: #667eea;">[æ”¾ç½®ç©ºé—´]</span>' : '<span style="font-size: 0.7em; color: #6c757d;">[å¯¹è±¡]</span>';
                const editingStatus = editingObjectIndex === index ? 
                    '<span style="font-size: 0.7em; color: #667eea;">(ç¼–è¾‘ä¸­)</span>' : 
                    '<span style="font-size: 0.7em; color: #28a745;">(å·²ä¿å­˜)</span>';
                objectItem.innerHTML = `
                    <div class="object-item-header">
                        <div class="object-item-name">${displayName} ${typeLabel} ${editingStatus}</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="object-item-points">${obj.points.length} ä¸ªç‚¹</div>
                            <div class="object-item-actions">
                                <button class="btn-icon btn-edit" onclick="editObject(${index})" title="ç¼–è¾‘å¯¹è±¡ç‚¹">âœï¸</button>
                                <button class="btn-icon btn-delete" onclick="deleteObject(${index})" title="åˆ é™¤å¯¹è±¡">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(objectItem);
            });

            // æ˜¾ç¤ºæ­£åœ¨ç¼–è¾‘çš„å¯¹è±¡
            if (currentObjectIndex !== -1 && currentObjectPoints.length > 0) {
                const objectItem = document.createElement('div');
                objectItem.className = 'object-item editing-object';
                const displayName = currentObjectName || `ç›®æ ‡å¯¹è±¡ ${currentObjectIndex + 1}`;
                const typeLabel = currentObjectType === 'space' ? '<span style="font-size: 0.7em; color: #667eea;">[æ”¾ç½®ç©ºé—´]</span>' : '<span style="font-size: 0.7em; color: #6c757d;">[å¯¹è±¡]</span>';
                objectItem.innerHTML = `
                    <div class="object-item-header">
                        <div class="object-item-name">${displayName} ${typeLabel} <span style="font-size: 0.7em; color: #ffc107;">(ç¼–è¾‘ä¸­)</span></div>
                        <div class="object-item-points">${currentObjectPoints.length} ä¸ªç‚¹</div>
                    </div>
                `;
                container.appendChild(objectItem);
            }
        }

        // åŠ è½½è§†é¢‘çš„æ ‡æ³¨æ•°æ®
        function loadVideoAnnotations() {
            if (!currentVideo) return;

            const annotationKey = `${folderPath}|${currentVideo.name}`;
            const annotation = annotations[annotationKey];

            // æ¸…é™¤ç°æœ‰æ ‡è®°
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());

            // é‡ç½®å·²ä¿å­˜å¯¹è±¡åˆ—è¡¨
            savedObjects = [];

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ— æ•ˆè§†é¢‘
            if (annotation && annotation.is_invalid === true) {
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µï¼ˆä½†ä¿ç•™å…¨å±€ä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯ï¼‰
                // ä¸åœ¨è¿™é‡Œæ¸…ç©ºä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯ï¼Œè®©å®ƒä»¬ä¿ç•™å…¨å±€å€¼
                currentObjectIndex = -1;
                currentObjectPoints = [];
                currentObjectName = '';
                currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
                updateObjectsList();
                showStatus('æ­¤è§†é¢‘å·²æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘', 'error');
                return;
            }

            // å…¼å®¹æ—§çš„objectså­—æ®µå’Œæ–°çš„object_spaceå­—æ®µ
            const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
            
            if (!annotation || objectSpaceList.length === 0) {
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µå’Œæ˜¾ç¤º
                currentObjectIndex = -1;
                currentObjectPoints = [];
                currentObjectName = '';
                currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
                savedObjects = []; // ç¡®ä¿æ¸…ç©ºå·²ä¿å­˜å¯¹è±¡åˆ—è¡¨
                
                // å¦‚æœæ˜¯æœªæ ‡æ³¨çš„è§†é¢‘ï¼Œä¿ç•™å…¨å±€ä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯çš„å€¼
                // å¦‚æœå…¨å±€å€¼å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å…¨å±€å€¼ï¼›å¦åˆ™æ¸…ç©º
                if (!annotation) {
                    if (globalTaskTemplate) {
                        document.getElementById('task-template').value = globalTaskTemplate;
                    } else {
                        document.getElementById('task-template').value = '';
                    }
                    if (globalScene) {
                        document.getElementById('scene').value = globalScene;
                    } else {
                        document.getElementById('scene').value = '';
                    }
                }
                
                // æ¸…ç©ºASRç»“æœæ˜¾ç¤º
                document.getElementById('asr-text-content').style.display = 'none';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
                currentASRResult = null;
                
                updateObjectsList();
                return;
            }

            // åŠ è½½æ ‡æ³¨çš„å¯¹è±¡
            // å…ˆè®¾ç½®ä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯
            if (annotation.task_template) {
                document.getElementById('task-template').value = annotation.task_template;
                globalTaskTemplate = annotation.task_template; // æ›´æ–°å…¨å±€å˜é‡
            }
            if (annotation.scene) {
                document.getElementById('scene').value = annotation.scene;
                globalScene = annotation.scene; // æ›´æ–°å…¨å±€å˜é‡
            }

            // åŠ è½½ASRç»“æœ
            if (annotation.asr_result) {
                currentASRResult = annotation.asr_result;
                // æ˜¾ç¤ºASRè¯†åˆ«ç»“æœï¼ˆæ”¯æŒå¤šä¸ªå¥å­ï¼‰
                displayASRResult(currentASRResult);
            } else {
                currentASRResult = null;
                // å¦‚æœæ²¡æœ‰ASRç»“æœï¼Œæ¸…ç©ºæ˜¾ç¤º
                document.getElementById('asr-text-content').style.display = 'none';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
            }

            console.log(`[æ ‡æ³¨äº¤äº’] åŠ è½½å·²æœ‰æ ‡æ³¨`, {
                video: currentVideo.name,
                annotation_id: annotation.id,
                task_template: annotation.task_template,
                scene: annotation.scene,
                objects_count: objectSpaceList.length,
                has_asr_result: !!annotation.asr_result,
                timestamp: new Date().toISOString()
            });

            // ä¿å­˜å·²åŠ è½½çš„å¯¹è±¡åˆ°savedObjectsï¼Œç¡®ä¿åŒ…å«typeå­—æ®µ
            savedObjects = objectSpaceList.map(obj => ({
                name: obj.name || '',
                points: obj.points || [],
                type: obj.type || 'object'  // å¦‚æœæ²¡æœ‰typeå­—æ®µï¼Œé»˜è®¤ä¸º'object'ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            }));

            // ä¸ºæ¯ä¸ªå·²ä¿å­˜çš„å¯¹è±¡åˆ›å»ºæ ‡è®°ç‚¹
            renderSavedObjects();

            // æ˜¾ç¤ºå¯¹è±¡åˆ—è¡¨
            updateObjectsList();
        }

        // æ¸²æŸ“å·²ä¿å­˜çš„å¯¹è±¡æ ‡è®°ç‚¹
        function renderSavedObjects() {
            const imageContainer = document.getElementById('image-container');
            const imageRect = document.getElementById('last-frame-image').getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            
            const imageOffsetX = (containerRect.width - imageRect.width) / 2;
            const imageOffsetY = (containerRect.height - imageRect.height) / 2;

            savedObjects.forEach((obj, objIndex) => {
                obj.points.forEach((point, pointIdx) => {
                    // pointæ ¼å¼åº”è¯¥æ˜¯ [y, x] å½’ä¸€åŒ–åæ ‡ (0-1000)
                    const normalizedX = point[1] / 1000;
                    const normalizedY = point[0] / 1000;
                    
                    const displayX = normalizedX * imageRect.width + imageOffsetX;
                    const displayY = normalizedY * imageRect.height + imageOffsetY;
                    
                    // åˆ›å»ºå·²ä¿å­˜çš„æ ‡è®°ç‚¹
                    createPointMarker(
                        { displayX, displayY },
                        objIndex,
                        true, // isSaved = true
                        obj.name,
                        pointIdx
                    );
                });
            });
        }


        // æ”¹å˜æ’­æ”¾é€Ÿåº¦
        function changePlaybackSpeed() {
            const videoPlayer = document.getElementById('video-player');
            const speed = parseFloat(document.getElementById('playback-speed').value);
            videoPlayer.playbackRate = speed;
        }

        // æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘
        async function markAsInvalidVideo() {
            if (!currentVideo) {
                showStatus('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦å°†æ­¤è§†é¢‘æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘å—ï¼Ÿæ ‡è®°åæ‰€æœ‰å­—æ®µå°†è¢«æ¸…ç©ºã€‚')) {
                return;
            }

            // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
            savedObjects = [];
            currentObjectIndex = -1;
            currentObjectPoints = [];
            currentObjectName = '';
            currentObjectType = 'object'; // é‡ç½®å¯¹è±¡ç±»å‹
            selectedPointIndex = -1;
            editingObjectIndex = -1;
            editingObjectPoints = [];
            currentASRResult = null; // æ¸…ç©ºASRç»“æœ
            
            // æ¸…ç©ºä»»åŠ¡æ¨¡æ¿å’Œåœºæ™¯
            document.getElementById('task-template').value = '';
            document.getElementById('scene').value = '';
            
            // æ¸…é™¤æ‰€æœ‰æ ‡è®°ç‚¹
            const imageContainer = document.getElementById('image-container');
            const markers = imageContainer.querySelectorAll('.point-marker');
            markers.forEach(marker => marker.remove());
            
            // éšè—ç¼–è¾‘æŒ‰é’®
            document.getElementById('save-editing-btn').style.display = 'none';
            document.getElementById('cancel-editing-btn').style.display = 'none';
            
            // æ¸…ç©ºASRç»“æœæ˜¾ç¤º
            document.getElementById('asr-text-content').style.display = 'none';
            document.getElementById('asr-error').style.display = 'none';
            document.getElementById('asr-loading').style.display = 'none';
            
            // æ›´æ–°UI
            updateObjectsList();
            updateStats();
            
            // æ„å»ºæ ‡æ³¨æ•°æ®ï¼ˆæ ‡è®°ä¸ºæ— æ•ˆï¼‰
            const annotationKey = `${folderPath}|${currentVideo.name}`;
            const existingAnnotation = annotations[annotationKey];
            const annotationId = existingAnnotation?.id || Date.now().toString();

            const annotationData = {
                id: annotationId,
                folder: folderPath,
                video_name: currentVideo.name,
                task_template: '',
                scene: '',
                object_space: [],  // å­—æ®µåæ”¹ä¸ºobject_space
                is_invalid: true,  // æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘
                asr_result: null  // æ¸…ç©ºASRç»“æœ
            };

            annotations[annotationKey] = annotationData;
            
            console.log(`[æ ‡æ³¨äº¤äº’] æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘`, {
                video: currentVideo.name,
                folder: folderPath,
                timestamp: new Date().toISOString()
            });

            try {
                const response = await fetch('/api/simple_annotation/save_annotations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        annotations: annotations
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }

                showStatus('å·²æ ‡è®°ä¸ºæ— æ•ˆè§†é¢‘', 'success');
                displayVideoList();
                updateProgress();
                updateStats();
                
                // å»¶è¿Ÿä¸€ä¸‹å†è·³è½¬ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                setTimeout(() => {
                    jumpToNextUnannotated();
                }, 500);
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜æ ‡æ³¨ï¼ˆä¿å­˜æ‰€æœ‰å·²ä¿å­˜çš„å¯¹è±¡åˆ°æ–‡ä»¶ï¼‰
        async function saveAnnotations(silent = false) {
            if (!currentVideo) {
                showStatus('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ— æ•ˆè§†é¢‘
            const annotationKey = `${folderPath}|${currentVideo.name}`;
            const existingAnnotation = annotations[annotationKey];
            if (existingAnnotation && existingAnnotation.is_invalid) {
                // å¦‚æœä¹‹å‰æ ‡è®°ä¸ºæ— æ•ˆï¼Œç°åœ¨è¦ä¿å­˜æ­£å¸¸æ ‡æ³¨ï¼Œéœ€è¦æ¸…é™¤æ— æ•ˆæ ‡è®°
                // ç»§ç»­æ‰§è¡Œä¿å­˜æµç¨‹
            } else if (savedObjects.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ å¹¶ä¿å­˜è‡³å°‘ä¸€ä¸ªç›®æ ‡å¯¹è±¡æˆ–æ”¾ç½®ç©ºé—´', 'error');
                return;
            }

            const taskTemplate = document.getElementById('task-template').value.trim();
            const scene = document.getElementById('scene').value.trim();
            
            // æ›´æ–°å…¨å±€å˜é‡
            globalTaskTemplate = taskTemplate;
            globalScene = scene;

            if (!taskTemplate || !scene) {
                showStatus('è¯·å¡«å†™ä»»åŠ¡æŒ‡ä»¤æ¨¡æ¿å’Œåœºæ™¯', 'error');
                return;
            }

            // æ„å»ºæ ‡æ³¨æ•°æ®
            const annotationId = existingAnnotation?.id || Date.now().toString();

            // ä½¿ç”¨å·²ä¿å­˜çš„å¯¹è±¡åˆ—è¡¨
            const annotationData = {
                id: annotationId,
                folder: folderPath,
                video_name: currentVideo.name,
                task_template: taskTemplate,
                scene: scene,
                object_space: savedObjects,  // å­—æ®µåæ”¹ä¸ºobject_space
                is_invalid: false,  // æ˜ç¡®æ ‡è®°ä¸ºéæ— æ•ˆè§†é¢‘
                asr_result: currentASRResult  // ä¿å­˜å®Œæ•´çš„ASRç»“æœï¼ˆåŒ…æ‹¬å¥å­çº§åˆ«å’Œè¯æ±‡çº§åˆ«ï¼‰
            };

            annotations[annotationKey] = annotationData;
            
            // æ‰“å°ä¿å­˜æ ‡æ³¨çš„äº¤äº’ä¿¡æ¯
            console.log(`[æ ‡æ³¨äº¤äº’] ä¿å­˜æ ‡æ³¨åˆ°æ–‡ä»¶`, {
                video: currentVideo.name,
                folder: folderPath,
                task_template: taskTemplate,
                scene: scene,
                objects_count: savedObjects.length,
                objects: savedObjects.map(obj => ({
                    name: obj.name,
                    type: obj.type || 'object',
                    points_count: obj.points.length
                })),
                timestamp: new Date().toISOString()
            });

            try {
                const response = await fetch('/api/simple_annotation/save_annotations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        annotations: annotations
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }

                if (!silent) {
                    showStatus('æ ‡æ³¨ä¿å­˜æˆåŠŸï¼', 'success');
                    // æ›´æ–°æ ‡æ³¨æ•°æ®åï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæœªæ ‡æ³¨çš„è§†é¢‘
                    displayVideoList();
                    updateProgress();
                    updateStats();
                    // å»¶è¿Ÿä¸€ä¸‹å†è·³è½¬ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                    setTimeout(() => {
                        jumpToNextUnannotated();
                    }, 500);
                } else {
                    displayVideoList();
                    updateProgress();
                    updateStats();
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæœªæ ‡æ³¨çš„è§†é¢‘ï¼ˆä»å½“å‰è§†é¢‘ä¹‹åå¼€å§‹ï¼‰
        function jumpToNextUnannotated() {
            // ä»å½“å‰è§†é¢‘çš„ä¸‹ä¸€ä¸ªå¼€å§‹æŸ¥æ‰¾
            const startIndex = currentVideoIndex >= 0 ? currentVideoIndex + 1 : 0;
            
            for (let i = startIndex; i < videos.length; i++) {
                const video = videos[i];
                const annotationKey = `${folderPath}|${video.name}`;
                const annotation = annotations[annotationKey];
                const isInvalid = annotation && annotation.is_invalid === true;
                const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                const isAnnotated = objectSpaceList.length > 0;
                
                // è·³è¿‡æ— æ•ˆè§†é¢‘å’Œå·²æ ‡æ³¨çš„è§†é¢‘
                if (!isInvalid && !isAnnotated) {
                    selectVideo(i);
                    return;
                }
            }
            
            // å¦‚æœä»å½“å‰ä½ç½®å¾€åæ²¡æ‰¾åˆ°ï¼Œä»å¤´å¼€å§‹æŸ¥æ‰¾
            for (let i = 0; i < startIndex; i++) {
                const video = videos[i];
                const annotationKey = `${folderPath}|${video.name}`;
                const annotation = annotations[annotationKey];
                const isInvalid = annotation && annotation.is_invalid === true;
                const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                const isAnnotated = objectSpaceList.length > 0;
                
                // è·³è¿‡æ— æ•ˆè§†é¢‘å’Œå·²æ ‡æ³¨çš„è§†é¢‘
                if (!isInvalid && !isAnnotated) {
                    selectVideo(i);
                    return;
                }
            }
            
            showStatus('æ‰€æœ‰è§†é¢‘éƒ½å·²æ ‡æ³¨æˆ–æ ‡è®°ä¸ºæ— æ•ˆ', 'success');
        }

        // è·³è½¬åˆ°æœªæ ‡æ³¨çš„è§†é¢‘
        function jumpToUnannotated() {
            for (let i = 0; i < videos.length; i++) {
                const video = videos[i];
                const annotationKey = `${folderPath}|${video.name}`;
                const annotation = annotations[annotationKey];
                const objectSpaceList = annotation ? (annotation.object_space || annotation.objects || []) : [];
                const isAnnotated = objectSpaceList.length > 0;
                
                if (!isAnnotated) {
                    selectVideo(i);
                    return;
                }
            }
            
            showStatus('æ‰€æœ‰è§†é¢‘éƒ½å·²æ ‡æ³¨', 'success');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºASRè¯†åˆ«ç»“æœï¼ˆæ”¯æŒå¤šä¸ªå¥å­ï¼‰
        function displayASRResult(asrResult) {
            if (!asrResult) {
                document.getElementById('asr-text-content').style.display = 'none';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
                return;
            }

            // å¦‚æœæœ‰å®Œæ•´æ–‡æœ¬ï¼Œç›´æ¥æ˜¾ç¤º
            if (asrResult.text && asrResult.text.trim()) {
                document.getElementById('asr-text-content').textContent = asrResult.text;
                document.getElementById('asr-text-content').style.display = 'block';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
            } 
            // å¦‚æœæœ‰å¤šä¸ªå¥å­ï¼Œåˆå¹¶æ˜¾ç¤º
            else if (asrResult.sentences && asrResult.sentences.length > 0) {
                const fullText = asrResult.sentences.map(s => s.text).join(' ');
                document.getElementById('asr-text-content').textContent = fullText;
                document.getElementById('asr-text-content').style.display = 'block';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
            }
            // å¦‚æœæœ‰å•ä¸ªå¥å­ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
            else if (asrResult.sentence && asrResult.sentence.text) {
                document.getElementById('asr-text-content').textContent = asrResult.sentence.text;
                document.getElementById('asr-text-content').style.display = 'block';
                document.getElementById('asr-error').style.display = 'none';
                document.getElementById('asr-loading').style.display = 'none';
            }
            else {
                document.getElementById('asr-text-content').style.display = 'none';
                document.getElementById('asr-error').style.display = 'block';
                document.getElementById('asr-error').textContent = 'âš ï¸ æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹';
                document.getElementById('asr-loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>

